var checkedNum = 0;
var refreshStop = 0;
var jsonWorkers = [];
var toFixedValue = 2;
if (currency == "BTC") {
    toFixedValue = 5;
}
var groupsFrame;
var coinsFrame;
var clientsFrame;
var wasHidden = 0;
$(document).on('visibilitychange', function () {
    if (document.visibilityState == 'hidden') {
        if ($('.new_worker_menu').is(":visible")) {
            wasHidden = 0;
        } else {
            wasHidden = 1;
        }
    } else {
        wasHidden = 0;
        workersRefresh(true);
    }
});
var workersStabilityArray = [];
if (workersStability != 'null') {
    workersStabilityArray = JSON.parse(workersStability);
}
var workersRebootsArray = [];
if (workersReboots != 'null') {
    workersRebootsArray = JSON.parse(workersReboots);
}
var workersConsoleArray = [];
if (workersConsole != 'null') {
    workersConsoleArray = JSON.parse(workersConsole);
}
if ($('.discover_workers_menu').length > 0) {
    var ps_discovery = new PerfectScrollbar('.discover_workers_menu #finish .frame', {
        wheelSpeed: 1,
        wheelPropagation: false,
        suppressScrollX: true
    });
}
if ($('.actions_submenu').length > 0) {
    var ps_bulk_switch = new PerfectScrollbar('.actions_submenu .frame', {
        wheelSpeed: 1,
        minScrollbarLength: 20,
        wheelPropagation: false,
        suppressScrollX: true
    });
}
(function ($) {
    $(window).on("load", function () {
        if (document.getElementById("groupsFrame") !== null) {
            groupsFrame = new PerfectScrollbar('#groupsFrame', {wheelSpeed: 1, wheelPropagation: false});
            groupsFrame.update();
        }
        if (document.getElementById("coinsFrame") !== null) {
            coinsFrame = new PerfectScrollbar('#coinsFrame', {wheelSpeed: 1, wheelPropagation: false});
            coinsFrame.update();
        }
        if (document.getElementById("clientsFrame") !== null) {
            clientsFrame = new PerfectScrollbar('#clientsFrame', {wheelSpeed: 1, wheelPropagation: false});
            clientsFrame.update();
        }
    });
})(jQuery);
var selectedWorkers = [];
function selectAll(thisElem) {
    totalNumWorkers = jsonWorkers.length;
    if (checkedNum > 0) {
        $('#checked_rows').hide();
        $('th').removeClass('hidden');
        $('#actions_menu').hide();
        $('table .checkbox').removeClass('selected');
        checkedNum = 0;
        $('#count').html(0);
        selectedWorkers = [];
    } else {
        $('table .checkbox').removeClass('selected');
        $('table tr:visible .checkbox').addClass('selected');
        $('#checked_rows').show();
        $('th').addClass('hidden');
        $('.check').show();
        selectedWorkers = [];
        $.each(jsonWorkers, function (wName, value) {
            var searchFound = false;
            var tagFound = false;
            if (tag != '') {
                var tagsTag = tag.split(":");
                var tagsArray = value.groups.toLowerCase().split(",");
                var tagsArrayFilter = value.filterString.split(",");
                tagsArray = tagsArray.concat(tagsArrayFilter);
                var tagsArrayNew = tagsArray.filter(function (el) {
                    return el != null && el != "";
                });
                tagsArray = tagsArrayNew;
                $.each(tagsTag, function (tagIndex, tagValue) {
                    if (tagsArray.indexOf(tagValue) !== -1) {
                        tagFound = true;
                    } else {
                        tagFound = false;
                        return false;
                    }
                });
            } else {
                tagFound = true;
            }
            if (search != '') {
                if (value['crypto'].toLowerCase().indexOf(search.toLowerCase()) >= 0 || value['name'].toLowerCase().indexOf(search.toLowerCase()) >= 0 || value['groups'].toLowerCase().indexOf(search.toLowerCase()) >= 0 || value['localip'].indexOf(search.toLowerCase()) >= 0 || value['remoteip'].indexOf(search.toLowerCase()) >= 0) {
                    searchFound = true;
                }
            } else {
                searchFound = true;
            }
            if (searchFound && tagFound) {
                selectedWorkers.push(value['id']);
                checkedNum++;
                $('#count').html(checkedNum);
            }
        });
    }
}

$(function () {
    $('table').on('click', 'td .checkbox', function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
            checkedNum--;
            $('#count').html(checkedNum);
            if (checkedNum == 0) {
                $('#checked_rows').hide();
                $('th').removeClass('hidden');
                $('#actions_menu').hide();
                selectedWorkers = [];

            } else {
                // var index = selectedWorkers.indexOf($(this).closest('[data-name]').attr('data-name'));
                var index = selectedWorkers.indexOf($(this).closest('[data-id]').attr('data-id'));
                if (index > -1) {
                    selectedWorkers.splice(index, 1);
                }
            }
        } else {
            $(this).addClass('selected');
            checkedNum++;
            $('#checked_rows').show();
            $('th').addClass('hidden');
            $('#count').html(checkedNum);
            $('.check').show();
            selectedWorkers.push($(this).closest('[data-id]').attr('data-id'));
        }
    });
    $('.filter_menu .checkbox').click(function () {
        var filterVal = $(this).parent().attr('data-value');
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
            $('table .filter_' + filterVal).each(function () {
                $(this).hide();
            });
        } else {
            $(this).addClass('selected');
            $('table .filter_' + filterVal).each(function () {
                $(this).show();
            });
        }
    });
    $('#actions_button').click(function () {
        $('#actions_menu').fadeToggle('fast');
    });
    $('#addNewWorker').click(function () {
        $('.new_worker_menu').fadeToggle('fast');
    });
    var manualMode = 1;
    $('#discoverNewWorker').click(function () {
        if ($('#discoverNewWorker').parent().hasClass('button_group')) {
            $('.discover_workers_menu').fadeToggle('fast');
        } else {
            if (manualMode == 1) {
                $('.discover_workers_menu').show();
                $('.add_new_worker_menu').hide();
                $(this).html(_('Switch to manual mode'));
                manualMode = 0;
            } else {
                $('.discover_workers_menu').hide();
                $('.add_new_worker_menu').show();
                $(this).html(_('Switch to Discovery tool'));
                manualMode = 1;
            }
        }
    });
    $(document).mousedown(function (e) {
        var container = $(".button_group .new_worker_menu");
        if (!container.is(e.target) && container.has(e.target).length === 0 && (!$("#addNewWorker").is(e.target)) && (!$(".icon.plus").is(e.target)) && e.target.localName != 'html') {
            container.hide();
        }
    });
    $(document).mousedown(function (e) {
        var container = $(".button_group .discover_workers_menu");
        if (!container.is(e.target) && container.has(e.target).length === 0 && (!$("#discoverNewWorker").is(e.target)) && (!$(".icon.discover").is(e.target)) && e.target.localName != 'html') {
            container.hide();
        }
    });
    $('#type').change(function () {
        if ($(this).val() == 'asic') {
            $('#asic_login').show();
            $('#system_asic').show();
            $('#system_gpu').hide();
            $('#tags .tag_system').html($('#system_asic option:selected').val());
        } else {
            $('#system_gpu').show();
            $('#system_asic').hide();
            $('#asic_login').hide();
            $('#tags .tag_system').html($('#system_gpu option:selected').val());
        }
        $('#tags .tag_type').html($(this).val());
    });
    $('#system_asic,#system_gpu').change(function () {
        if ($(this).val() == 'dragonmint') {
            $('#sshpass').val('dragonadmin');
            $('#sshuser').val('admin');
        } else if ($(this).val() == 'antminer') {
            $('#sshpass').val('admin');
            $('#sshuser').val('root');
        } else if ($(this).val() == 'aisen') {
            $('#sshpass').val('root');
            $('#sshuser').val('root');
        } else if ($(this).val() == 'avalon') {
            $('#sshpass').val('root');
            $('#sshuser').val('root');
        } else if ($(this).val() == 'obelisk') {
            $('#sshpass').val('admin');
            $('#sshuser').val('admin');
        } else if ($(this).val() == 'blackminer') {
            $('#sshpass').val('root');
            $('#sshuser').val('root');
        } else if ($(this).val() == 'strongu') {
            $('#sshpass').val('root');
            $('#sshuser').val('root');
        } else if ($(this).val() == 'baikal') {
            $('#sshpass').val('root');
            $('#sshuser').val('admin');
        } else if ($(this).val() == 'fusionsilicon') {
            $('#sshpass').val('fusion');
            $('#sshuser').val('fusion');
        } else if ($(this).val() == 'innosilicon') {
            $('#sshpass').val('innot1t2');
            $('#sshuser').val('root');
        } else if ($(this).val() == 'goldshell') {
            $('#sshpass').val('123456789');
            $('#sshuser').val('admin');
        } else if ($(this).val() == 'ebang') {
            $('#sshpass').val('admin');
            $('#sshuser').val('admin');
        } else if ($(this).val() == 'toddminer') {
            $('#sshpass').val('admin');
            $('#sshuser').val('admin');
        } else if ($(this).val() == 'cheetah') {
            $('#sshpass').val('admin');
            $('#sshuser').val('admin');
        } else if ($(this).val() == 'dayun') {
            $('#sshpass').val('envision');
            $('#sshuser').val('root');
        } else if ($(this).val() == 'spondoolies') {
            $('#sshpass').val('root');
            $('#sshuser').val('root');
        } else if ($(this).val() == 'hyperbit') {
            $('#sshpass').val('bwcon');
            $('#sshuser').val('root');
        } else if ($(this).val() == 'whatsminer') {
            $('#sshpass').val('root');
            $('#sshuser').val('root');
        }
        $('#tags .tag_system').html($(this).val());
    });
    $("#tag").keyup(function (e) {
        var value = $('#tag').val();
        value = value.replace(/[^a-zA-Z0-9]+/g, "");
        value = value.substring(0, 10);
        $('#tag').val(value);
        if ((e.which == 13 || e.which == 32) && value != '') {
            $("#tags #tag").before('<div class="tag" data-value="' + value + '">' + value + ' <div class="icon close"></div></div>');
            $('#tag').val('').focus();
        }
    });
    $("#tags").click(function (event) {
        if (event.target.id == "tags") {
            $('#tag').focus();
        }
    });
    $(document).on('click', '.tag .close', function () {
        $(this).parent().remove();
    });
    $('#popup_type').change(function () {
        if ($(this).val() == 'asic') {
            $('.text.asic').show();
            $('#popup_system_asic').show();
            $('#popup_system_gpu').hide();
            $('#rename_worker #popup_system_asic option').removeAttr('selected');
            $('#rename_worker #popup_system_gpu option').removeAttr('selected');
            $('#popup_system_asic option[value="antminer"]').attr("selected", "selected");
            $('.asicpassword').val('admin');
            $('.asicuser').val('root');
            $('#groups .tag_system').html($('#popup_system_asic option:selected').val());
        } else {
            $('#popup_system_gpu').show();
            $('#popup_system_asic').hide();
            $('.text.asic').hide();
            $('#groups .tag_system').html($('#popup_system_gpu option:selected').val());
        }
        $('#groups .tag_type').html($(this).val());
    });
    $('#popup_system_asic,#popup_system_gpu').change(function () {
        if ($(this).val() == 'dragonmint') {
            $('.asicpassword').val('dragonadmin');
            $('.asicuser').val('admin');
        } else if ($(this).val() == 'antminer') {
            $('.asicpassword').val('admin');
            $('.asicuser').val('root');
        } else if ($(this).val() == 'aisen') {
            $('.asicpassword').val('root');
            $('.asicuser').val('root');
        } else if ($(this).val() == 'avalon') {
            $('.asicpassword').val('root');
            $('.asicuser').val('root');
        } else if ($(this).val() == 'obelisk') {
            $('.asicpassword').val('admin');
            $('.asicuser').val('admin');
        } else if ($(this).val() == 'blackminer') {
            $('.asicpassword').val('root');
            $('.asicuser').val('root');
        } else if ($(this).val() == 'strongu') {
            $('.asicpassword').val('root');
            $('.asicuser').val('root');
        } else if ($(this).val() == 'baikal') {
            $('.asicpassword').val('root');
            $('.asicuser').val('admin');
        } else if ($(this).val() == 'fusionsilicon') {
            $('.asicpassword').val('fusion');
            $('.asicuser').val('fusion');
        } else if ($(this).val() == 'innosilicon') {
            $('.asicpassword').val('innot1t2');
            $('.asicuser').val('root');
        } else if ($(this).val() == 'goldshell') {
            $('.asicpassword').val('123456789');
            $('.asicuser').val('admin');
        } else if ($(this).val() == 'ebang') {
            $('.asicpassword').val('admin');
            $('.asicuser').val('admin');
        } else if ($(this).val() == 'toddminer') {
            $('.asicpassword').val('admin');
            $('.asicuser').val('admin');
        } else if ($(this).val() == 'cheetah') {
            $('.asicpassword').val('admin');
            $('.asicuser').val('admin');
        } else if ($(this).val() == 'dayun') {
            $('.asicpassword').val('envision');
            $('.asicuser').val('root');
        } else if ($(this).val() == 'spondoolies') {
            $('.asicpassword').val('root');
            $('.asicuser').val('root');
        } else if ($(this).val() == 'hyperbit') {
            $('.asicpassword').val('bwcon');
            $('.asicuser').val('root');
        } else if ($(this).val() == 'whatsminer') {
            $('asicpassword').val('root');
            $('.asicuser').val('root');
        }
        $('#groups .tag_system').html($(this).val());
    });
    $("#popup_tag").keyup(function (e) {
        var value = $('#popup_tag').val();
        value = value.replace(/[^a-zA-Z0-9]+/g, "");
        value = value.substring(0, 10);
        $('#popup_tag').val(value);
        if ((e.which == 13 || e.which == 32) && value != '') {
            $("#groups #popup_tag").before('<div class="tag" data-value="' + value + '">' + value + ' <div class="icon close"></div></div>');
            $('#popup_tag').val('').focus();
        }
    });
    $("#groups").click(function (event) {
        if (event.target.id == "groups") {
            $('#popup_tag').focus();
        }
    });
    $('#button_addworker').on('click', function () {
        var $this = $(this);
        if ($this.hasClass('disabled')) {
            return false;
        }
        $this.addClass('disabled');
        $('.checkmark').hide();
        $('.circle-loader').removeClass('load-complete');
        $('.circle-loader, .message_err, .message_suc').hide();
        $('.circle-loader').show();
        var workerName = $('#workerName').val();
        var type = $('#type').val();
        if (type == 'asic') {
            var system = $('#system_asic').val();
            var asicIp = $('#ip').val();
            var asicSSHuser = $('#sshuser').val();
            var asicSSHpass = $('#sshpass').val();
        } else {
            var system = $('#system_gpu').val();
            var asicIp = '';
            var asicSSHuser = '';
            var asicSSHpass = '';
        }
        var tags = '';
        $('#tags').find('.tag').each(function () {
            tags += ';' + $(this).attr('data-value') + ';';
        });
        var nonce = $('#nonce').val();
        var data = '';
        $.post(window.location.href, {
            workerName: workerName,
            sshuser: asicSSHuser,
            sshpass: asicSSHpass,
            asicIp: asicIp,
            type: type,
            system: system,
            groups: tags,
            nonce: nonce
        }, function (response) {
            data = response;
            if (data == '1') {
                if ($('#newWorker').val() == 'yes') {
                    var d = new Date();
                    d.setTime(d.getTime() + 24 * 60 * 60 * 1000 * 365);
                    var expires = "expires=" + d.toLocaleTimeString();
                    document.cookie = "cmode=automaticConfig;" + expires + ";path=/";
                    window.location.replace("/worker/" + workerName);
                } else {
                    location.reload();
                }
            } else {
                $('.circle-loader').hide();
                $('.notification_row').addClass('finished');
                $this.removeClass('disabled');
                $('.message_err').html(data).show();
                if (data == _("Set worker's name.")) {
                    $('#workerName').addClass('error_value');
                }
                if (data.split('. ')[0] + '.' == _("Worker name already in use.")) {
                    $('#workerName').addClass('error_value');
                }
                if (data == _('Worker name can only contain<br>letters, numbers, "_", "-".')) {
                    $('#workerName').addClass('error_value');
                }
                if (data == _("Worker name shouldn't exceed 15 chars.")) {
                    $('#workerName').addClass('error_value');
                }
                if (data == _("Invalid ASIC IP.")) {
                    $('#ip').addClass('error_value');
                }
            }
        });
    });
    $('table').on('click', '.tag', function () {
        tag = $(this).text().toLowerCase();
        $('#checked_rows').hide();
        $('th').removeClass('hidden');
        $('#actions_menu').hide();
        $('table .checkbox').removeClass('selected');
        checkedNum = 0;
        selectedWorkers = [];
        if ($('.search_result').html().indexOf('<div class="result">' + tag + ' <div class="icon close"></div></div>') == -1) {
            $('.search_result').html($('.search_result').html() + '<div class="result">' + tag + ' <div class="icon close"></div></div>');
            $('.filter_popup').find("#filter_group_" + $(this).text().toLowerCase() + "").prop('checked', true);
        }
        $('.search_result > .result').each(function () {
            if (tag != '') {
                tag = tag + ':' + $(this).text().trim();
            } else {
                tag = $(this).text().trim();
            }
        });
        var d = new Date;
        d.setTime(d.getTime() + 7 * 24 * 60 * 60 * 1000);
        document.cookie = "workersFilter=" + tag + ";path=/;expires=" + d.toGMTString();
        workersPage(page, search, tag, sort);
    });
    $('.icon.search').on('click', function () {
        $("#search").focus();
    });
    var delay = (function () {
        var timer = 0;
        return function (callback, ms) {
            clearTimeout(timer);
            timer = setTimeout(callback, ms);
        };
    })();
    $("#search").on('keyup', function () {
        delay(function () {
            search = $("#search").val().toLowerCase();
            workersPage(page, search, tag, sort);
            $('#checked_rows').hide();
            $('th').removeClass('hidden');
            $('#actions_menu').hide();
            $('table .checkbox').removeClass('selected');
            checkedNum = 0;
            selectedWorkers = [];
        }, 500);
    });
    $(document).on('click', '.result', function () {
        $('#checked_rows').hide();
        $('th').removeClass('hidden');
        $('#actions_menu').hide();
        $('table .checkbox').removeClass('selected');
        checkedNum = 0;
        selectedWorkers = [];
        tag = '';
        $('.filter_popup').find("#filter_" + $(this).text().toLowerCase().replace('(', '').replace(')', '').replace(' ', '') + "").prop('checked', false);
        $('.filter_popup').find("#filter_group_" + $(this).text().toLowerCase().replace('(', '').replace(')', '').replace(' ', '') + "").prop('checked', false);
        $('.search_result').html($('.search_result').html().replace('<div class="result">' + $(this).html() + '</div>', ''));
        $('.search_result > .result').each(function () {
            if (tag != '') {
                tag = tag + ':' + $(this).text().trim();
            } else {
                tag = $(this).text().trim();
            }
        });
        var d = new Date;
        d.setTime(d.getTime() + 7 * 24 * 60 * 60 * 1000);
        document.cookie = "workersFilter=" + tag + ";path=/;expires=" + d.toGMTString();
        workersPage(page, search, tag, sort);
    });
    if (workers == null) {
        preloaderHide();
    } else {
        workersInit();
    }
    $('.close,.close_popup').click(function () {
        $('.popupbackground').fadeOut('fast');
        $('.popup').fadeOut('fast');
        closeKeyPwdWin()
    });
    $('table').on('click', '.icons_list_hamburger', function () {
        if (!$(this).parent().children('.icons_list').hasClass('hide')) {
            $(this).parent().children('.icons_list').addClass('hide');
            refreshStop = 0;
        } else {
            $('.icons_list').addClass('hide');
            $(this).parent().children('.icons_list').removeClass('hide');
            refreshStop = 1;
        }
    });
});
var sort = 'nameAsc';
var page = 1;
var search = '';
// var tag = getFilterTag();
var tag = ''
var start = 0;
var end = 25;
var pageHash = window.location.hash.substr(1);
if (pageHash > 0) {
    page = pageHash;
}
if ("onhashchange" in window) {
    window.onhashchange = function () {
        keyWinClose()
        workersPage(window.location.hash.substr(1), search, tag, type);
    }
} else {
    var storedHash = window.location.hash.substr(1);
    window.setInterval(function () {
        if (window.location.hash.substr(1) != storedHash) {
            storedHash = window.location.hash.substr(1);
            workersPage(storedHash, search, tag, type);
        }
    }, 100);
}

function workersSort(type) {
    sort = type;
    var d = new Date;
    d.setTime(d.getTime() + 24 * 60 * 60 * 1000 * 15);
    document.cookie = "workersSort=" + type + ";path=/;expires=" + d.toGMTString();
    workersPage(page, search, tag, type);
}

function workersPage(currentPage, currentSearch, currentTag, currentSort) {
    if (typeof currentPage == 'undefined' || currentPage == '') {
        currentPage = page;
    }
    if (typeof currentSearch == 'undefined' || currentSearch == '') {
        currentSearch = search;
    }
    if (typeof currentTag == 'undefined' || currentTag == '') {
        currentTag = '';
    }
    if (typeof currentSort == 'undefined' || currentSort == '') {
        currentSort = sort;
    }
    page = currentPage;
    if (page > 0) {
        if (history.pushState) {
            history.pushState(null, null, '#' + page);
        } else {
            location.hash = '#' + page;
        }
    }
    search = currentSearch.toLowerCase();
    tag = currentTag.toLowerCase();
    sort = currentSort;
    start = (currentPage * 25) - 25;
    end = start + 25;
    var counter = 0;
    var pages = 1;
    $('.order_icon').removeClass('asc desc');
    // $('#sort_name').attr('onclick', "workersSort('nameDesc');");
    // $('#sort_mining').attr('onclick', "workersSort('miningDesc');");
    // $('#sort_client').attr('onclick', "workersSort('clientDesc');");
    // $('#sort_temp').attr('onclick', "workersSort('tempDesc');");
    // $('#sort_fans').attr('onclick', "workersSort('fansDesc');");
    // $('#sort_watt').attr('onclick', "workersSort('wattDesc');");
    // $('#sort_uptime').attr('onclick', "workersSort('uptimeDesc');");
    // $('#sort_earnings').attr('onclick', "workersSort('earningsDesc');");
    // if (currentSort != '') {
    //     jsonWorkers.sort(function (row1, row2) {
    //         switch (currentSort) {
    //             case 'nameDesc':
    //                 var a = row2['name'];
    //                 var b = row1['name'];
    //                 $('#sort_name').attr('onclick', "workersSort('nameAsc');").addClass('desc');
    //                 break;
    //             case 'nameAsc':
    //                 var a = row1['name'];
    //                 var b = row2['name'];
    //                 $('#sort_name').attr('onclick', "workersSort('nameDesc');").addClass('asc');
    //                 break;
    //             case 'miningDesc':
    //                 var a = row2['mining_status_value'];
    //                 var b = row1['mining_status_value'];
    //                 $('#sort_mining').attr('onclick', "workersSort('miningAsc');").addClass('desc');
    //                 break;
    //             case 'miningAsc':
    //                 var a = row1['mining_status_value'];
    //                 var b = row2['mining_status_value'];
    //                 $('#sort_mining').attr('onclick', "workersSort('miningDesc');").addClass('asc');
    //                 break;
    //             case 'tempDesc':
    //                 var a = row2['temp_value'];
    //                 var b = row1['temp_value'];
    //                 $('#sort_temp').attr('onclick', "workersSort('tempAsc');").addClass('desc');
    //                 break;
    //             case 'tempAsc':
    //                 var a = row1['temp_value'];
    //                 var b = row2['temp_value'];
    //                 $('#sort_temp').attr('onclick', "workersSort('tempDesc');").addClass('asc');
    //                 break;
    //             case 'fansDesc':
    //                 var a = row2['fan_value'];
    //                 var b = row1['fan_value'];
    //                 $('#sort_fans').attr('onclick', "workersSort('fansAsc');").addClass('desc');
    //                 break;
    //             case 'fansAsc':
    //                 var a = row1['fan_value'];
    //                 var b = row2['fan_value'];
    //                 $('#sort_fans').attr('onclick', "workersSort('fansDesc');").addClass('asc');
    //                 break;
    //             case 'wattDesc':
    //                 var a = row2['watt_value'];
    //                 var b = row1['watt_value'];
    //                 $('#sort_watt').attr('onclick', "workersSort('wattAsc');").addClass('desc');
    //                 break;
    //             case 'wattAsc':
    //                 var a = row1['watt_value'];
    //                 var b = row2['watt_value'];
    //                 $('#sort_watt').attr('onclick', "workersSort('wattDesc');").addClass('asc');
    //                 break;
    //             case 'uptimeDesc':
    //                 var a = row2['uptime_value'];
    //                 var b = row1['uptime_value'];
    //                 $('#sort_uptime').attr('onclick', "workersSort('uptimeAsc');").addClass('desc');
    //                 break;
    //             case 'uptimeAsc':
    //                 var a = row1['uptime_value'];
    //                 var b = row2['uptime_value'];
    //                 $('#sort_uptime').attr('onclick', "workersSort('uptimeDesc');").addClass('asc');
    //                 break;
    //             case 'earningsDesc':
    //                 var a = row2['revenue_value'];
    //                 var b = row1['revenue_value'];
    //                 $('#sort_earnings').attr('onclick', "workersSort('earningsAsc');").addClass('desc');
    //                 break;
    //             case 'earningsAsc':
    //                 var a = row1['revenue_value'];
    //                 var b = row2['revenue_value'];
    //                 $('#sort_earnings').attr('onclick', "workersSort('earningsDesc');").addClass('asc');
    //                 break;
    //         }
    //         if (currentSort == 'nameDesc' || currentSort == 'nameAsc' || currentSort == 'miningDesc' || currentSort == 'miningAsc' || currentSort == 'clientDesc' || currentSort == 'clientAsc') {
    //             if (a > b) return 1; else if (a < b) return -1;
    //             return 0;
    //         }
    //         if (currentSort == 'earningsAsc' || currentSort == 'earningsDesc' || currentSort == 'uptimeAsc' || currentSort == 'uptimeDesc') {
    //             a = parseFloat(a);
    //             b = parseFloat(b);
    //             if (a > b) return 1; else if (a < b) return -1;
    //             return 0;
    //         }
    //         var reA = /[^a-zA-Z]/g;
    //         var reN = /[^0-9]/g;
    //         if (typeof a !== 'undefined') {
    //             var aA = a.replace(reA, "");
    //             var bA = b.replace(reA, "");
    //             if (aA === bA) {
    //                 var aN = parseInt(a.replace(reN, ""), 10);
    //                 var bN = parseInt(b.replace(reN, ""), 10);
    //                 return aN === bN ? 0 : aN > bN ? 1 : -1;
    //             } else {
    //                 return aA > bA ? 1 : -1;
    //             }
    //         }
    //     });
    // }
    printWorkers();
}

function toSeconds(uptimeStr) {
    var uptimeStrArray = (uptimeStr).split(' ');
    uptimeSeconds = 0;
    $.each(uptimeStrArray, function (timeI, timeD) {
        if (timeD.indexOf('d') != -1) {
            uptimeSeconds = uptimeSeconds + parseInt(timeD) * 24 * 60 * 60;
        }
        if (timeD.indexOf('h') != -1) {
            uptimeSeconds = uptimeSeconds + parseInt(timeD) * 60 * 60;
        }
        if (timeD.indexOf('m') != -1) {
            uptimeSeconds = uptimeSeconds + parseInt(timeD) * 60;
        }
        if (timeD.indexOf('s') != -1) {
            uptimeSeconds = uptimeSeconds + parseInt(timeD);
        }
    });
    return uptimeSeconds;
}

function workersInit() {
    workersRefresh(true);
}

function workersRefresh(cache) {
    if (wasHidden > 0) {
        return;
    }
    if (checkedNum > 0 || refreshStop > 0) {
        setTimeout(function () {
            workersRefresh(false);
        }, 5 * 1000);
        return false;
    }
    var workersList = '';
    if (typeof (Storage) !== "undefined" && cache) {
    }
    if (cacheExpired || workersList == '' || workersList == null) {
        // var apiUrl = '/static-ssl.minerstat.farm/hercules.php?token=' + workerToken + '&count=' + workersCount;
        var apiUrl = '/managerquery?token=' + workerToken + '&count=' + workersCount;
        if (demoAccount == 1) {
            apiUrl = '/managerquery';
        }
        $.getJSON(apiUrl, function (workersList) {
            // loadWorkers(workersList);
            jsonWorkers=workersList
            // if (workersList != '' && window.sessionStorage) {
            //     sessionStorage.setItem(workerToken.toLowerCase() + ".workersList", JSON.stringify(workersList));
            //     var newDate = new Date();
            //     sessionStorage.setItem("lastUpdate", newDate.getTime());
            // }
            printWorkers()
        });
    } else {
        loadWorkers(JSON.parse(workersList));
    }

    function loadWorkers(workersList) {
        jsonWorkers = [];
        var count_online = 0;
        var count_offline = 0;
        var count_idle = 0;
        var count_alerts_pause = 0;
        var count_triggers_pause = 0;
        var count_notes = 0;
        var count_profitswitch = 0;
        var count_nospeed = 0;
        var count_noefficiency = 0;
        var count_notemperature = 0;
        var count_nofans = 0;
        var count_nopool = 0;
        var count_nocoin = 0;
        var count_missinggpus = 0;
        var count_idlegpus = 0;
        var count_hotlimit = 0;
        var count_veryhotlimit = 0;
        var count_duplicatedips = 0;
        var count_nospace = 0;
        var count_stability = 0;
        var count_reboots = 0;
        var count_console = 0;
        var filter_groups = {};
        var filter_coins = {};
        var filter_clients = {};
        var asicArrayIP = {};
        var asicArrayIPGroups = {};
        var groupsString = ",msos,windows,asic,nvidia,amd,innosilicon,goldshell,toddminer,cheetah,ebang,whatsminer,antminer,avalon,aisen,blackminer,baikal,dragonmint,dayun,spondoolies,hyperbit,obelisk,strongu,fusionsilicon,";
        $.each(workersList, function (i, w) {
            var filters_string = '';
            var uptimeSeconds = 24 * 60 * 60;
            if (typeof w['info'].uptime != 'undefined' && w['info'].uptime != null) {
                var uptimeStrArray = (w['info'].uptime).split(' ');
                uptimeSeconds = 0;
                $.each(uptimeStrArray, function (timeI, timeD) {
                    if (timeD.indexOf('d') != -1) {
                        uptimeSeconds = uptimeSeconds + parseInt(timeD) * 24 * 60 * 60;
                    }
                    if (timeD.indexOf('h') != -1) {
                        uptimeSeconds = uptimeSeconds + parseInt(timeD) * 60 * 60;
                    }
                    if (timeD.indexOf('m') != -1) {
                        uptimeSeconds = uptimeSeconds + parseInt(timeD) * 60;
                    }
                    if (timeD.indexOf('s') != -1) {
                        uptimeSeconds = uptimeSeconds + parseInt(timeD);
                    }
                });
            }
            var jsonWorker = {};
            jsonWorker['id'] = w['info'].id
            jsonWorker['type'] = w['info'].type;
            jsonWorker['system'] = w['info'].system;
            jsonWorker['groups'] = w['info'].groups;
            if (typeof w['info'].os != 'undefined' && typeof w['info'].os.localip != 'undefined') {
                jsonWorker['localip'] = w['info'].os.localip;
            } else {
                jsonWorker['localip'] = '';
            }
            if (typeof w['info'].os != 'undefined' && typeof w['info'].os.remoteip != 'undefined') {
                jsonWorker['remoteip'] = w['info'].os.remoteip;
            } else {
                jsonWorker['remoteip'] = '';
            }
            jsonWorker['client'] = '';
            jsonWorker['name'] = w['info'].name;
            var groupsList = w['info'].groups.split(',');
            $.each(groupsList, function (groupIndex, groupName) {
                if (typeof filter_groups[groupName.toUpperCase()] == 'undefined') filter_groups[groupName.toUpperCase()] = 0;
                filter_groups[groupName.toUpperCase()]++;
            });
            jsonWorker['mining_status_value'] = '0';
            jsonWorker['temp_value'] = '0';
            jsonWorker['fan_value'] = '0';
            jsonWorker['watt_value'] = '0';
            jsonWorker['uptime_value'] = '0';
            jsonWorker['revenue_value'] = '0';
            jsonWorker['crypto'] = '';
            jsonWorker['profit_switch'] = '';
            jsonWorker['mining_unit'] = '';
            jsonWorker['hardware_list'] = [];
            jsonWorker['temp_hot'] = '';
            jsonWorker['temp_veryhot'] = '';
            jsonWorker['type'] = '';
            var statusClass;
            var statusName;
            if (w['info'].status == 'offline' && w['info']['os'].status == 'online' && w['info'].status_reason != 'SWITCHING' && w['info'].status_reason != 'FLASHING' && w['info'].status_reason != 'BENCHMARKING' && w['info'].status_reason != 'INITIALIZING' && w['info'].status_reason != 'BOOTING') {
                statusClass = 'idle';
                statusName = _('Idle');
                count_idle++;
                filters_string += 'idle,';
            } else {
                if (w['info'].status == 'offline' && w['info'].status_reason != 'SWITCHING' && w['info'].status_reason != 'FLASHING' && w['info'].status_reason != 'BENCHMARKING' && w['info'].status_reason != 'INITIALIZING' && w['info'].status_reason != 'BOOTING') {
                    statusClass = 'offline';
                    statusName = _('Offline');
                    count_offline++;
                    filters_string += 'offline,';
                } else {
                    if (w['info'].status_reason == 'SWITCHING') {
                        statusClass = 'switching';
                        statusName = _('Switching');
                    } else if (w['info'].status_reason == 'INITIALIZING') {
                        statusClass = 'initializing';
                        statusName = _('Initializing');
                    } else if (w['info'].status_reason == 'BOOTING') {
                        statusClass = 'booting';
                        statusName = _('Booting');
                    } else if (w['info'].status_reason == 'BENCHMARKING') {
                        statusClass = 'benchmarking';
                        statusName = _('Benchmarking');
                    } else if (w['info'].status_reason == 'FLASHING') {
                        statusClass = 'flashing';
                        statusName = _('BIOS flashing');
                    } else {
                        statusClass = 'online';
                        statusName = _('Online');
                    }
                    count_online++;
                    filters_string += 'online,';
                }
            }
            if (typeof w['mining'] != 'undefined' && typeof w['mining']["crypto"] != 'undefined' && w['mining']["crypto"] == 'BENCHMARK') {
                statusName = _('Benchmarking');
                statusClass = 'benchmarking';
            }
            if (w['info']['note'] == '0') {
                jsonWorker['status'] = '<div data-tooltip="' + statusName + '" data-html="' + statusClass + '" class="status ' + statusClass + '"><div class="bullet"></div></div><div onclick="editNote(\'' + i + '\')" data-tooltip="' + _('Without notes') + '" class="notes disabled"><div class="icon note"></div></div>';
                jsonWorker['note'] = 0;
            } else {
                jsonWorker['status'] = '<div data-tooltip="' + statusName + '" data-html="' + statusClass + '" class="status ' + statusClass + '"><div class="bullet"></div></div><div onclick="editNote(\'' + i + '\')" data-tooltip="' + _('Note') + '" class="notes"><div class="icon note"></div></div>';
                jsonWorker['note'] = 1;
                count_notes++;
                filters_string += 'notes,';
            }
            if (w['info']['profit_switch'] == '1') {
                count_profitswitch++;
                filters_string += 'profitswitch,';
            }
            if (typeof w["info"]["os"] != 'undefined' && typeof w["info"]["os"]["localip"] != 'undefined' && w["info"]["os"]["localip"] != '0.0.0.0') {
                var groups = w["info"]["groups"].split(',');
                var workerGroups = [];
                $.each(groups, function (gIndex, group) {
                    if (groupsString.indexOf(group) == -1) {
                        if (asicArrayIPGroups[group] == null) asicArrayIPGroups[group] = {};
                        if (asicArrayIPGroups[group][w["info"]["os"]["localip"]] == null) asicArrayIPGroups[group][w["info"]["os"]["localip"]] = [];
                        asicArrayIPGroups[group][w["info"]["os"]["localip"]].push(w["info"]["name"]);
                        workerGroups.push('group-' + group);
                    }
                });
                if (w["info"]["type"] == 'asic') {
                    if (asicArrayIP[w["info"]["os"]["localip"]] == null) asicArrayIP[w["info"]["os"]["localip"]] = [];
                    asicArrayIP[w["info"]["os"]["localip"]].push([w["info"]["name"], workerGroups]);
                }
            }
            if (w["info"]["os"]["freespace"] == 0) {
                count_nospace++;
                filters_string += 'nospace,';
            }
            if (jQuery.inArray(w['workersId'], workersStabilityArray) != -1) {
                count_stability++;
                filters_string += 'stability,';
            }
            if (jQuery.inArray(w['workersId'], workersRebootsArray) != -1) {
                count_reboots++;
                filters_string += 'reboots,';
            }
            if (jQuery.inArray(w['workersId'], workersConsoleArray) != -1) {
                count_console++;
                filters_string += 'console,';
            }
            if (w['info']['pauseAlerts'] != 'undefined') {
                jsonWorker['pause_alerts'] = w['info']['pauseAlerts'];
                if (w['info']['pauseAlerts'] == 1) {
                    count_alerts_pause++;
                    filters_string += 'alerts_pause,';
                }
            }
            if (w['info']['pauseTriggers'] != 'undefined') {
                jsonWorker['pause_triggers'] = w['info']['pauseTriggers'];
                if (w['info']['pauseTriggers'] == 1) {
                    count_triggers_pause++;
                    filters_string += 'triggers_pause,';
                }
            }
            if (w['info'].status != 'offline' || w['info']['os'].status != 'offline') {
                if (typeof w['mining'].client != 'undefined' && w['mining'].client != null) {
                    jsonWorker['client'] = w['mining'].client.toUpperCase();
                } else {
                    jsonWorker['client'] = _('Undetected');
                }
                if (w['info']['type'] == 'asic') {
                    jsonWorker['asic'] = 1;
                    jsonWorker['client_cpu'] = '';
                } else {
                    jsonWorker['asic'] = 0;
                    jsonWorker['client_cpu'] = '';
                    if (typeof w['mining'].client_cpu != 'undefined' && w['mining'].client_cpu != null && w['mining'].client_cpu != '') {
                        jsonWorker['client_cpu'] = w['mining'].client_cpu.toUpperCase();
                    }
                }
                if (statusClass != 'offline') {
                    var fanSuffix = '%';
                    if (w['info']['type'] == 'asic') {
                        fanSuffix = ' RPM';
                    }
                    fanTooltip = '';
                    tempTooltip = '';
                    var hardwareCount = 0;
                    var powerCount = 0;
                    var hardwareFan = 0;
                    var hardwareTemp = 0;
                    var hardwareTemp2 = '';
                    var memTemp = '';
                    var driverError = 0;
                    var tempCount = 0;
                    var fanCount = 0;
                    var fanError = 0;
                    var speedError = 0;
                    var throttlingError = 0;
                    var speedCount = 0;
                    var tempError = 0;
                    var miningTooltipTop = '';
                    var miningTooltip = '';
                    var miningError = 0;
                    var miningUndefined = 0;
                    var wattSum = 0;
                    var hardwareWatt = '';
                    var wattTooltip = '';
                    var numberGPUs = '';
                    var tempWarning = 0;
                    var g = 0;
                    if (typeof w['info']['veryHot'] != 'undefined') {
                        jsonWorker['temp_veryhot'] = w['info']['veryHot'];
                    }
                    if (typeof w['info']['hot'] != 'undefined') {
                        jsonWorker['temp_hot'] = w['info']['hot'];
                    }
                    $.each(w['hardware'], function (hardwareIndex, hardwareData) {
                        var errorsList = '';
                        var isHardwareError = false;
                        if (typeof hardwareData['alertSlow'] != 'undefined') {
                            errorsList = '<span class="error_tag"> (' + _('GPU throttled') + ')</span>';
                            isHardwareError = true;
                            throttlingError = 1;
                        }
                        if (typeof hardwareData['alertThermal'] != 'undefined') {
                            errorsList = '<span class="error_tag"> (' + _('GPU throttled') + ')</span>';
                            isHardwareError = true;
                            throttlingError = 1;
                        }
                        if (typeof hardwareData['alertPower'] != 'undefined') {
                            errorsList = '<span class="error_tag"> (' + _('GPU throttled') + ')</span>';
                            isHardwareError = true;
                            throttlingError = 1;
                        }
                        if (typeof hardwareData['alertTemp'] != 'undefined') {
                            errorsList = '<span class="error_tag"> (' + _('GPU throttled') + ')</span>';
                            isHardwareError = true;
                            throttlingError = 1;
                        }
                        jsonWorker['hardware_list'].push(hardwareData);
                        if (hardwareData['temp'] > hardwareTemp && hardwareData['temp'] < 500) {
                            hardwareTemp = hardwareData['temp'];
                        }
                        if (typeof hardwareData['temp2'] != 'undefined' && hardwareData['temp2'] > hardwareTemp2 && hardwareData['temp2'] < 500) {
                            hardwareTemp2 = hardwareData['temp2'];
                        }
                        if (typeof hardwareData['memTemp'] != 'undefined' && hardwareData['memTemp'] > memTemp && hardwareData['memTemp'] < 500) {
                            memTemp = hardwareData['memTemp'];
                        }
                        if (hardwareData['fan'] > hardwareFan) {
                            hardwareFan = hardwareData['fan'];
                        }
                        if (hardwareData['temp'] > 500 || hardwareData['temp'] < 0) {
                            driverError = 1;
                        }
                        if (typeof hardwareData['temp'] == "undefined" || hardwareData['temp'] < 0) {
                            tempTooltip += '<div><span class="red">#' + hardwareIndex + ': -</span></div>';
                            tempError = 1;
                        } else {
                            var temp2 = '';
                            var temp2Value = 0;
                            if (typeof hardwareData['temp2'] != "undefined" && hardwareData['temp2'] > 0) {
                                temp2 = ' &middot; ' + convertTemperature(hardwareData['temp2']) + temperature;
                                temp2Value = hardwareData['temp2'];
                            }
                            if (typeof hardwareData['memTemp'] != "undefined" && hardwareData['memTemp'] > 0) {
                                temp2 = ' &middot; ' + convertTemperature(hardwareData['memTemp']) + temperature;
                                temp2Value = hardwareData['memTemp'];
                            }
                            if (hardwareData['temp'] >= w['info']['veryHot'] || hardwareData['temp'] < 0) {
                                tempWarning = 2;
                                tempError = 1;
                                tempTooltip += '<div><span class="red">#' + hardwareIndex + ': ' + convertTemperature(hardwareData['temp']) + temperature + temp2 + '</span></div>';
                            } else if (hardwareData['temp'] >= w['info']['hot']) {
                                tempTooltip += '<div><span class="yellow">#' + hardwareIndex + ': ' + convertTemperature(hardwareData['temp']) + temperature + temp2 + '</span></div>';
                            } else {
                                tempTooltip += '<div>#' + hardwareIndex + ': ' + convertTemperature(hardwareData['temp']) + temperature + temp2 + '</div>';
                            }
                        }
                        if (typeof hardwareData['fan'] == "undefined") {
                            fanTooltip += '<div><span class="red">#' + hardwareIndex + ': -</span></div>';
                        } else {
                            if ((w['info']['type'] == 'asic' && hardwareData['fan'] > 0) || w['info']['type'] != 'asic') {
                                fanTooltip += '<div>#' + hardwareIndex + ': ' + hardwareData['fan'] + fanSuffix + '</div>';
                                if ((hardwareData['fan'] == 0 && w['info']['type'] != 'asic') || (hardwareData['fan'] == 0 && w['info']['type'] == 'asic' && g < 2)) {
                                    fanError = 1;
                                }
                            }
                        }
                        if (typeof hardwareData['speed'] == "undefined") {
                            speedError = 1;
                        } else {
                            if (w['info']['type'] != 'asic') {
                                if ((hardwareData['speed'] == 0)) {
                                    speedError = 1;
                                } else {
                                    speedCount++;
                                }
                            }
                        }
                        var hardwareName = '';
                        if (typeof hardwareData['name'] != 'undefined' && hardwareData['name'] != '') {
                            hardwareName = ' ' + hardwareData['name'] + errorsList;
                        }
                        if (typeof hardwareData['speed'] == "undefined") {
                            if (w['info']['type'] == 'asic') {
                                miningTooltip += '<div class="gpu_row"><div class="gpu_name">#' + hardwareIndex + hardwareName + '</div><div class="gpu_value">-</div></div>';
                            } else {
                                miningTooltip += '<div class="gpu_row"><div class="gpu_name"><span class="red">#' + hardwareIndex + hardwareName + '</span></div><div class="gpu_value"><span class="red">-</span></div></div>';
                                miningError = 1;
                            }
                        } else {
                            miningUndefined++;
                            if (isHardwareError) {
                                miningTooltip += '<div class="gpu_row"><div class="gpu_name"><span class="red">#' + hardwareIndex + hardwareName + '</span></div><div class="gpu_value">' + convertHashrate(speedToHash(parseFloat(hardwareData['speed']), w['mining']['hashrate']['hashrate_unit']), 'H/s') + '</div></div>';
                            } else {
                                miningTooltip += '<div class="gpu_row"><div class="gpu_name">#' + hardwareIndex + hardwareName + '</div><div class="gpu_value">' + convertHashrate(speedToHash(parseFloat(hardwareData['speed']), w['mining']['hashrate']['hashrate_unit']), 'H/s') + '</div></div>';
                            }
                            if (hardwareData['speed'] == 0) {
                                miningError = 1;
                            }
                        }
                        if (typeof hardwareData['power'] == 'undefined') {
                            if (w['info']['type'] == 'asic') {
                                wattTooltip += '<div>#' + hardwareIndex + ': -</div>';
                            } else {
                                wattTooltip += '<div><span class="red">#' + hardwareIndex + ': -</span></div>';
                            }
                        } else {
                            wattSum += hardwareData['power'];
                            wattTooltip += '<div>#' + hardwareIndex + ': ' + hardwareData['power'] + ' W</div>';
                            powerCount++;
                        }
                        g++;
                    });
                    hardwareCount = g;
                    var revenueTooltip = '';
                    var firstBtc = false;
                    if (w['mining'].crypto.indexOf(' (') !== -1) {
                        firstBtc = true;
                    }
                    if (w['mining'].crypto.indexOf('+') == -1) {
                        revenueTooltip = '1 ' + getUnitFromCrypto(w['mining'].crypto) + ' = ' + (w['revenue'].cprice * currencyValue).toFixed(toFixedValue) + ' ' + currency;
                    }
                    if (!(typeof w['mining'] != 'undefined' && typeof w['mining']['pool'] != 'undefined' && w['mining']['pool'] != '')) {
                        count_nopool++;
                        filters_string += 'nopool,';
                    }
                    if (!(typeof w['mining'] != 'undefined' && typeof w['mining']['crypto'] != 'undefined' && w['mining']['crypto'] != '' && w['mining']['crypto'] != 'NO')) {
                        count_nocoin++;
                        filters_string += 'nocoin,';
                    }
                    if (typeof w["hardware"] != 'undefined' && typeof w["info"] != 'undefined' && typeof w["info"]["devices"] != 'undefined' && w["info"]["devices"] != 0 && w["hardware"].length != w["info"]["devices"]) {
                        count_missinggpus++;
                        filters_string += 'missinggpus,';
                    }
                    var mining = w['mining'].crypto + ' - ' + convertHashrate(speedToHash(parseFloat(w['mining']['hashrate'].hashrate), w['mining']['hashrate'].hashrate_unit), 'H/s');
                    var miningEfficiency = '';
                    var miningWarning = '';
                    var efficiencyValue = 0;
                    if (typeof w['mining'] != 'undefined' && typeof w['mining']['shares'] != 'undefined' && (parseInt(w["mining"]["shares"]["accepted_share"]) + parseInt(w["mining"]["shares"]["rejected_share"])) > 0) {
                        var acceptedShares = w["mining"]["shares"]["accepted_share"];
                        var rejectedShares = w["mining"]["shares"]["rejected_share"];
                        if (typeof w["mining"]["shares"]["accepted_share_dual"] != 'undefined') {
                            acceptedShares += w["mining"]["shares"]["accepted_share_dual"] + w["mining"]["shares"]["accepted_share_cpu"];
                            rejectedShares += w["mining"]["shares"]["rejected_share_dual"] + w["mining"]["shares"]["rejected_share_cpu"];
                        }
                        efficiencyValue = (100 * parseInt(acceptedShares) / (parseInt(acceptedShares) + parseInt(rejectedShares)));
                        if (efficiencyValue < 100) {
                            efficiencyValue = efficiencyValue.toFixed(2);
                        } else {
                            efficiencyValue = 100;
                        }
                        miningEfficiency = '<small>' + efficiencyValue + '% ' + _('efficiency') + ' &middot; ' + parseInt(acceptedShares) + ' &middot; ' + parseInt(rejectedShares) + '</small>';
                        if (efficiencyValue < 98 && uptimeSeconds >= 5 * 60) {
                            count_noefficiency++;
                            filters_string += 'noefficiency,';
                        }
                        if (efficiencyValue < 90) {
                            miningWarning = '<div class="icon hot"></div>';
                        }
                    } else {
                        miningEfficiency = '<small>' + '0% ' + _('efficiency') + ' &middot; 0 &middot; 0</small>';
                        if (uptimeSeconds >= 5 * 60) {
                            count_noefficiency++;
                            filters_string += 'noefficiency,';
                            miningWarning = '<div class="icon hot"></div>';
                        }
                    }
                    var efficiencyValueMultiplier = efficiencyValue / 100;
                    efficiencyValueMultiplier = 1;
                    if (typeof w['mining'] != 'undefined' && typeof w['mining']['hashrate'] != 'undefined' && w['mining']['hashrate'].hashrate == 0 && w['info']['status'] == 'online') {
                        if (uptimeSeconds >= 1 * 60) {
                            count_nospeed++;
                            filters_string += 'nospeed,';
                            miningWarning = '<div class="icon hot"></div>';
                        }
                    }
                    if (throttlingError == 1) {
                        miningWarning = '<div class="icon hot"></div>';
                    }
                    mining = miningWarning + mining;
                    jsonWorker['type'] = w['info'].type;
                    jsonWorker['crypto'] = w['mining'].crypto;
                    jsonWorker['mining_unit'] = w['mining']['hashrate'].hashrate_unit;
                    if (typeof filter_coins[w['mining'].crypto.toUpperCase()] == 'undefined') filter_coins[w['mining'].crypto.toUpperCase()] = 0;
                    filter_coins[w['mining'].crypto.toUpperCase()]++;
                    filters_string += w['mining'].crypto.toLowerCase() + ',';
                    var miningSortingStr = mining;
                    if (mining.indexOf(' - ') > 0) {
                        var miningSortingStr = '';
                        var miningSortingPrefix = mining.split(' - ')[0];
                        var miningSortingSpeed = mining.split(' - ')[1].split(' ')[0];
                        var miningSortingUnit = mining.split(' - ')[1].split(' ')[1];
                        if (miningSortingSpeed < 10) {
                            miningSortingSpeed = '000' + miningSortingSpeed;
                        } else if (miningSortingSpeed < 100) {
                            miningSortingSpeed = '00' + miningSortingSpeed;
                        } else if (miningSortingSpeed < 1000) {
                            miningSortingSpeed = '0' + miningSortingSpeed;
                        }
                        miningSortingStr = miningSortingPrefix + ' - ' + miningSortingSpeed + ' ' + miningSortingUnit;
                    }
                    jsonWorker['mining_status_value'] = miningSortingStr;
                    if (typeof w['mining'].crypto_dual !== "undefined" && w['mining'].crypto_dual != '') {
                        jsonWorker['crypto'] += ',' + w['mining'].crypto_dual;
                        if (typeof filter_coins[w['mining'].crypto_dual.toUpperCase()] == 'undefined') filter_coins[w['mining'].crypto_dual.toUpperCase()] = 0;
                        filter_coins[w['mining'].crypto_dual.toUpperCase()]++;
                        filters_string += w['mining'].crypto_dual.toLowerCase() + ',';
                        mining = mining + '<br>' + w['mining'].crypto_dual + ' - ' + parseFloat(w['mining']['hashrate'].hashrate_dual).toFixed(2) + ' ' + w['mining']['hashrate'].hashrate_unit_dual + '/s';
                        if (w['mining'].crypto_dual.indexOf('+') !== -1) {
                            if (w['mining'].crypto_dual.indexOf(' (') !== -1) {
                                if (firstBtc != true) {
                                    revenueTooltip = revenueTooltip + '<br>' + '1 ' + getUnitFromCrypto(w['mining'].crypto_dual) + ' = ' + (w['revenue'].cprice_dual * currencyValue).toFixed(toFixedValue) + ' ' + currency;
                                }
                            } else {
                                revenueTooltip = revenueTooltip + '<br>' + '1 ' + w['mining'].crypto_dual + ' = ' + (w['revenue'].cprice_dual * currencyValue).toFixed(toFixedValue) + ' ' + currency;
                            }
                        }
                    }
                    if (typeof w['mining'].crypto_cpu !== "undefined" && w['mining'].crypto_cpu != '') {
                        jsonWorker['crypto'] += ',' + w['mining'].crypto_cpu;
                        if (typeof filter_coins[w['mining'].crypto_cpu.toUpperCase()] == 'undefined') filter_coins[w['mining'].crypto_cpu.toUpperCase()] = 0;
                        filter_coins[w['mining'].crypto_cpu.toUpperCase()]++;
                        filters_string += w['mining'].crypto_cpu.toLowerCase() + ',';
                        mining = mining + '<br>' + w['mining'].crypto_cpu + ' - ' + parseFloat(w['mining']['hashrate'].hashrate_cpu).toFixed(2) + ' ' + w['mining']['hashrate'].hashrate_unit_cpu + '/s';
                        if (w['mining'].crypto_cpu.indexOf('+') !== -1) {
                            if (w['mining'].crypto_cpu.indexOf(' (') !== -1) {
                                if (firstBtc != true) {
                                    revenueTooltip = revenueTooltip + '<br>' + '1 ' + getUnitFromCrypto(w['mining'].crypto_cpu) + ' = ' + (w['revenue'].cprice_cpu * currencyValue).toFixed(toFixedValue) + ' ' + currency;
                                }
                            } else {
                                revenueTooltip = revenueTooltip + '<br>' + '1 ' + w['mining'].crypto_cpu + ' = ' + (w['revenue'].cprice_cpu * currencyValue).toFixed(toFixedValue) + ' ' + currency;
                            }
                        }
                    }
                    if (typeof w['mining'].client != 'undefined' && w['mining'].client != null) {
                        if (typeof filter_clients[w['mining'].client.toUpperCase()] == 'undefined') {
                            filter_clients[w['mining'].client.toUpperCase()] = 0;
                        }
                        filter_clients[w['mining'].client.toUpperCase()]++;
                        filters_string += w['mining'].client.toLowerCase() + ',';
                    }
                    var cpuTooltip = _('CPU mining disabled');
                    var cpuToggle = '';
                    if (typeof w['mining'].client_cpu != 'undefined' && w['mining'].client_cpu != '' && w['mining'].client_cpu != null && w['mining'].client_cpu != 'disabled') {
                        cpuTooltip = _('CPU mining enabled');
                        cpuToggle = 'selected';
                    }
                    jsonWorker['profit_switch'] = w['info']['profit_switch'];
                    var switchTooltip = _('Profit switch disabled');
                    var switchToggle = '';
                    if (jsonWorker['profit_switch'] == '1') {
                        switchTooltip = _('Profit switch enabled');
                        switchToggle = 'selected';
                    }
                    var cpuHtml = '';
                    var rigType = w['info'].type;
                    var rigSystem = w['info'].system;
                    if (rigSystem == 'linux') {
                        rigSystem = 'msos';
                    }
                    if (rigSystem == 'win') {
                        rigSystem = 'windows';
                    }
                    var clientsList = '<b>' + _('Load from template') + '</b>';
                    var countTemplates = 0;
                    var configTemplatesArray = [];
                    var configTemplatesObj = {};
                    jQuery.each(clients, function (client, data) {
                        if ($.inArray(rigType, data['for']) !== -1 && $.inArray(rigSystem, data['for']) !== -1 && typeof data['templates'] != 'undefined') {
                            $.each(data['templates'], function (index, value) {
                                configTemplatesArray.push(value.name.toLowerCase());
                                configTemplatesObj[value.name.toLowerCase()] = {};
                                configTemplatesObj[value.name.toLowerCase()]['id'] = value.id;
                                configTemplatesObj[value.name.toLowerCase()]['name'] = value.name;
                                configTemplatesObj[value.name.toLowerCase()]['client'] = client.toUpperCase();
                                countTemplates++;
                            });
                        }
                        if (rigType != 'asic') {
                            if ($.inArray(rigSystem, data['for']) !== -1 && $.inArray('cpu', data['for']) !== -1) {
                                cpuHtml = '<div class="divider"></div><div class="row"><label>' + _('CPU mining') + '</label><div data-tooltip="' + cpuTooltip + '" class="cpumining toggle" onclick="cpuMining(\'' + i + '\');"><div class="bullet ' + cpuToggle + '"></div></div></div>';
                            }
                        }
                    });
                    configTemplatesArray.sort();
                    jQuery.each(configTemplatesArray, function (configTemplateIndex, configTemplateName) {
                        configTemplateData = configTemplatesObj[configTemplateName];
                        clientsList += '<div class="row" data-template="' + configTemplateData['id'] + '">' + configTemplateData['name'] + '<small>' + configTemplateData['client'] + '</small></div>';
                    });
                    if (countTemplates == 0) {
                        clientsList += '<div class="empty">' + _('No templates') + '</div><a class="button green" href="/config-templates/new" title="' + _('Create new template') + '">' + _('Create new template') + '</a>';
                    }
                    if (typeof w['mining'].client != 'undefined' && w['mining'].client != null) {
                        var client = w['mining'].client.toUpperCase();
                    } else {
                        var client = _('Undetected');
                    }
                    clientsList = clientsList.replace('class="row">' + client, 'class="row selected">' + client);
                    jsonWorker['clients'] = clientsList;
                    if (w['info'].uptime != 'undefined' && w['info'].uptime != null) {
                        var uptime = w['info'].uptime;
                        var sync = w['info'].sync;
                        if (statusClass == 'idle' && typeof w['info']['os'].sync != 'undefined') {
                            sync = w['info']['os'].sync;
                        }
                        jsonWorker['uptime_value'] = toSeconds(uptime);
                        jsonWorker['uptime'] = '<div class="ttp">' + uptime + '<small>' + _('Last seen') + ': ' + sync + 's' + '</small></div>';
                    }
                    jsonWorker['revenue_value'] = (((w['revenue'].usd_month) * currencyValue * efficiencyValueMultiplier).toFixed(toFixedValue)).toString();
                    revenue = '<div class="earnings_dollar">' + ((w['revenue'].usd_month) * currencyValue * efficiencyValueMultiplier).toFixed(toFixedValue) + ' ' + currency + '</div>';
                    var cryptoUnit = getUnitFromCrypto(w['mining'].crypto);
                    var crypto_val = (30 * w['revenue'].coin * efficiencyValueMultiplier).toFixed(6) + ' ' + cryptoUnit;
                    if (typeof w['mining'].crypto_dual !== "undefined" && w['mining'].crypto_dual != '') {
                        cryptoUnit = getUnitFromCrypto(w['mining'].crypto_dual);
                        crypto_val += '<br>' + (30 * w['revenue'].coin_dual * efficiencyValueMultiplier).toFixed(6) + ' ' + cryptoUnit;
                    }
                    if (typeof w['mining'].crypto_cpu !== "undefined" && w['mining'].crypto_cpu != '') {
                        cryptoUnit = getUnitFromCrypto(w['mining'].crypto_cpu);
                        crypto_val += '<br>' + (30 * w['revenue'].coin_cpu * efficiencyValueMultiplier).toFixed(6) + ' ' + cryptoUnit;
                    }
                    if (cryptoUnit.indexOf('+') > 0) {
                        crypto_val = _('Merged mining');
                    }
                    revenue += '<div class="earnings_btc">' + crypto_val + '</div>';
                    var btcTooltip = '<div class="divider"></div>';
                    btcTooltip += _('Est. BTC') + ': ' + parseFloat(((w['revenue'].usd_month) * btcExchange * efficiencyValueMultiplier)).toFixed(8) + ' BTC';
                    jsonWorker['revenue'] = '<div class="ttp">' + revenue + '<div class="tooltip"><div class="arrow"></div>' + revenueTooltip + btcTooltip + '</div></div>';
                    if (jQuery.type(w['info']['consumption']) !== "string" && w['info']['consumption'] > 0) {
                        wattSum = w['info']['consumption'];
                        if (powerCount == 0) {
                            wattTooltip = '';
                        }
                    } else if (jQuery.type(w['info']['consumption']) === "string") {
                        wattSum += parseInt(w['info']['consumption'].replace('+', ''));
                        wattTooltip += '<div class="divider"></div><div>' + w['info']['consumption'] + ' W</div>';
                    }
                    if (typeof w['mining'] != 'undefined' && typeof w['mining']['client'] != 'undefined' && typeof w['mining']['pool'] != 'undefined') {
                        miningTooltipTop = '<b>' + w['mining']['client'] + '</b>' + '<br><small>' + w['mining']['pool'] + '</small>';
                        if (miningUndefined != 0) {
                            miningTooltipTop += '<br>' + miningTooltip;
                        }
                    }
                    var miningAddon = '';
                    if (miningTooltipTop != '') {
                        miningAddon = '<div class="tooltip"><div class="arrow"></div>' + miningTooltipTop + '</div>';
                    }
                    if (statusClass == 'idle') {
                        jsonWorker['mining_status'] = _('Idle');
                    } else if (statusClass == 'benchmarking') {
                        jsonWorker['mining_status'] = _('Benchmarking');
                    } else if (statusClass == 'switching') {
                        jsonWorker['mining_status'] = _('Switching');
                    } else if (statusClass == 'initializing') {
                        jsonWorker['mining_status'] = _('Initializing');
                    } else if (statusClass == 'booting') {
                        jsonWorker['mining_status'] = _('Booting');
                    } else if (statusClass == 'flashing') {
                        jsonWorker['mining_status'] = _('BIOS flashing');
                    } else {
                        jsonWorker['mining_status'] = '<div class="ttp">' + mining + miningEfficiency + miningAddon + '</div>';
                    }
                    if (speedError == 1 && speedCount > 0) {
                        count_idlegpus++;
                        filters_string += 'idlegpus,';
                    }
                    if (tempError == 1) {
                        count_notemperature++;
                        filters_string += 'notemperature,';
                    }
                    if (hardwareFan > 105) {
                        hardwareFan += ' RPM';
                    } else if (hardwareFan > 0) {
                        if (hardwareFan > 100) {
                            hardwareFan = 100;
                        }
                        hardwareFan += '%';
                        if (fanError == 1) {
                            hardwareFan = '<div class="icon hot"></div>' + hardwareFan;
                            count_nofans++;
                            filters_string += 'nofans,';
                        }
                    } else {
                        hardwareFan = '-';
                    }
                    if (hardwareTemp >= w['info']['hot'] && hardwareTemp < w['info']['veryHot']) {
                        count_hotlimit++;
                        filters_string += 'hotlimit,';
                        hardwareTemp = '<div class="icon warning"></div>' + convertTemperature(hardwareTemp) + temperature;
                    } else if (hardwareTemp >= w['info']['veryHot']) {
                        count_veryhotlimit++;
                        filters_string += 'veryhotlimit,';
                        hardwareTemp = '<div class="icon hot"></div>' + convertTemperature(hardwareTemp) + temperature;
                    } else if (driverError > 0) {
                        hardwareTemp = '<div class="icon hot"></div>' + convertTemperature(hardwareTemp) + temperature;
                    } else if (hardwareTemp > 0) {
                        hardwareTemp = convertTemperature(hardwareTemp) + temperature;
                    } else {
                        hardwareTemp = '-';
                    }
                    var fanAddon = '';
                    var tempAddon = '';
                    var wattAddon = '';
                    if (hardwareFan != '-') {
                        fanAddon = '<div class="tooltip"><div class="arrow"></div>' + fanTooltip + '</div>';
                    }
                    if (hardwareTemp != '-') {
                        tempAddon = '<div class="tooltip"><div class="arrow"></div>' + tempTooltip + '</div>';
                    }
                    if (hardwareWatt != '-' && wattTooltip != '') {
                        wattAddon = '<div class="tooltip"><div class="arrow"></div>' + wattTooltip + '</div>';
                    }
                    var numberGPUsWarning = '';
                    if (w['info']['devices'] != 'undefined' && w['info']['devices'] > 0) {
                        if (hardwareCount < w['info']['devices']) {
                            numberGPUsWarning = '<div data-tooltip="' + _('Missing GPUs') + '" class="icon hot"></div>';
                        }
                        if (hardwareCount > w['info']['devices']) {
                            numberGPUsWarning = '<div data-tooltip="' + _('GPUs count difference') + '" class="icon warning"></div>';
                        }
                        numberGPUs = numberGPUsWarning + hardwareCount + '/' + w['info']['devices'];
                    }
                    jsonWorker['temp_value'] = hardwareTemp.toString();
                    jsonWorker['fan_value'] = hardwareFan.toString();
                    jsonWorker['watt_value'] = wattSum.toString();
                    if (numberGPUsWarning != '') {
                        jsonWorker['watt_value'] = "9999999" + hardwareCount + '/' + w['info']['devices'];
                    }
                    jsonWorker['fan'] = '<div class="ttp">' + hardwareFan + fanAddon + '</div>';
                    if (hardwareTemp2 != '') {
                        hardwareTemp = hardwareTemp + ' &middot; ' + convertTemperature(hardwareTemp2) + temperature;
                    }
                    if (memTemp != '') {
                        hardwareTemp = hardwareTemp + '<small>' + convertTemperature(memTemp) + temperature + '</small>';
                    }
                    jsonWorker['temp'] = '<div class="ttp">' + hardwareTemp + tempAddon + '</div>';
                    if (wattSum > 0) {
                        var efficiencyWatt = (w['mining']['hashrate']['hashrate'] / wattSum).toFixed(3);
                        if (w['mining']['hashrate']['hashrate'] == 0) {
                            efficiencyWatt = 0;
                        }
                        var efficiencyWattString = '<small>' + efficiencyWatt + ' ' + w['mining']['hashrate']['hashrate_unit'] + '/W</small>';
                        if (efficiencyWatt == 0 && w['mining']['hashrate']['hashrate_unit'] != 'H') {
                            efficiencyWatt = (w['mining']['hashrate']['hashrate'] * 1000 / wattSum).toFixed(3);
                            efficiencyWattString = '<small>' + efficiencyWatt + ' ' + hashrateUnitDown(w['mining']['hashrate']['hashrate_unit']) + '/W</small>';
                        }
                        jsonWorker['watt'] = '<div class="ttp">' + numberGPUs + ' ' + wattSum + ' W ' + efficiencyWattString + wattAddon + '</div>';
                        if (w['info']['electricity'] != 'undefined' && w['info']['electricity'] > 0) {
                            jsonWorker['revenue_value'] = (((w['revenue'].usd_month * efficiencyValueMultiplier - 30 * 24 * wattSum * w['info']['electricity'] / 1000) * currencyValue).toFixed(toFixedValue)).toString();
                            revenue = '<div class="earnings_dollar">' + ((w['revenue'].usd_month * efficiencyValueMultiplier - 30 * 24 * wattSum * w['info']['electricity'] / 1000) * currencyValue).toFixed(toFixedValue) + ' ' + currency + '</div>';
                            var cryptoUnit = getUnitFromCrypto(w['mining'].crypto);
                            var crypto_val = (30 * w['revenue'].coin * efficiencyValueMultiplier).toFixed(6) + ' ' + cryptoUnit;
                            if (typeof w['mining'].crypto_dual !== "undefined" && w['mining'].crypto_dual != '') {
                                cryptoUnit = getUnitFromCrypto(w['mining'].crypto_dual);
                                crypto_val += '<br>' + (30 * w['revenue'].coin_dual * efficiencyValueMultiplier).toFixed(6) + ' ' + cryptoUnit;
                            }
                            if (typeof w['mining'].crypto_cpu !== "undefined" && w['mining'].crypto_cpu != '') {
                                cryptoUnit = getUnitFromCrypto(w['mining'].crypto_cpu);
                                crypto_val += '<br>' + (30 * w['revenue'].coin_cpu * efficiencyValueMultiplier).toFixed(6) + ' ' + cryptoUnit;
                            }
                            if (cryptoUnit.indexOf('+') > 0) {
                                crypto_val = _('Merged mining');
                            }
                            revenue += '<div class="earnings_btc">' + crypto_val + '</div>';
                            var costsTooltip = '';
                            if (revenueTooltip != '') {
                                costsTooltip += '<br><br>';
                            }
                            costsTooltip += _('Est. income') + ': ' + (w['revenue'].usd_month * currencyValue * efficiencyValueMultiplier).toFixed(toFixedValue) + ' ' + currency + '<br>' + _('El. costs') + ': ' + ((30 * 24 * wattSum * w['info']['electricity'] / 1000) * currencyValue).toFixed(toFixedValue) + ' ' + currency;
                            costsTooltip += '<br>' + _('Est. profit') + ': ' + ((w['revenue'].usd_month - (30 * 24 * wattSum * w['info']['electricity'] / 1000)) * currencyValue * efficiencyValueMultiplier).toFixed(toFixedValue) + ' ' + currency;
                            costsTooltip += '<div class="divider"></div>';
                            costsTooltip += _('Est. BTC') + ': ' + parseFloat(((w['revenue'].usd_month - (30 * 24 * wattSum * w['info']['electricity'] / 1000)) * btcExchange) * efficiencyValueMultiplier).toFixed(8) + ' BTC';
                            jsonWorker['revenue'] = '<div class="ttp">' + revenue + '<div class="tooltip"><div class="arrow"></div>' + revenueTooltip + costsTooltip + '</div></div>';
                        }
                    } else {
                        jsonWorker['watt'] = '<div class="ttp">' + numberGPUs + '</div>';
                    }
                    if (typeof w['info'].inactive != 'undefined' && w['info'].inactive != 0) {
                        var inactive = w['info'].inactive;
                        var timeNow = Math.round((new Date().getTime()) / 1000);
                        if (timeNow - 24 * 60 * 60 < inactive) {
                            var timeTotalSec = timeNow - inactive;
                            var minutes = 0;
                            var hours = 0;
                            var sec = 0;
                            minutes = timeTotalSec / 60;
                            if (minutes > 60) {
                                hours = Math.floor(minutes / 60);
                                minutes = Math.ceil(minutes - hours * 60);
                            } else {
                                minutes = Math.ceil(minutes);
                            }
                            var formattedTime = '';
                            if (hours == 0) {
                                formattedTime = ' ' + minutes + 'min';
                            } else {
                                formattedTime = ' ' + hours + 'h ' + minutes + 'min';
                            }
                            if (minutes == 0) {
                                formattedTime = ' < 1min';
                            }
                            var uptimeTemp = formattedTime;
                            var uptimeArrH = 0;
                            var uptimeArrM = 0;
                            var uptimeArrS = 0;
                            if (uptimeTemp.indexOf("h") >= 0) {
                                uptimeArrH = uptimeTemp.split('h');
                                uptimeArrH = parseInt(uptimeArrH[0]) * 3600;
                            }
                            if (uptimeTemp.indexOf("min") >= 0) {
                                uptimeArrM = uptimeTemp.split('min');
                                uptimeArrM = parseInt(uptimeArrM[0]) * 60;
                            }
                            if (uptimeTemp.indexOf("s") >= 0) {
                                uptimeArrS = uptimeTemp.split('s');
                                uptimeArrS = parseInt(uptimeArrS[0]);
                            }
                            uptimeTemp = -1 * (uptimeArrH + uptimeArrM + uptimeArrS);
                            jsonWorker['uptime_value'] = uptimeTemp.toString();
                            jsonWorker['uptime'] = _('Inactive for') + formattedTime;
                        } else {
                            uptimeTemp = -1 * (2 * 24 * 60 * 60);
                            jsonWorker['uptime_value'] = uptimeTemp.toString();
                            jsonWorker['uptime'] = _('Inactive for') + ' > 24h';
                        }
                    }
                } else {
                    if (typeof w['info'].last_seen != 'undefined') {
                        var lastSeen = w['info'].last_seen;
                        var timeNow = Math.round((new Date().getTime()) / 1000);
                        if (timeNow - 24 * 60 * 60 < lastSeen) {
                            var timeTotalSec = timeNow - lastSeen;
                            var minutes = 0;
                            var hours = 0;
                            var sec = 0;
                            minutes = timeTotalSec / 60;
                            if (minutes > 60) {
                                hours = Math.floor(minutes / 60);
                                minutes = Math.ceil(minutes - hours * 60);
                            } else {
                                minutes = Math.ceil(minutes);
                            }
                            var formattedTime = '';
                            if (hours == 0) {
                                formattedTime = ' ' + minutes + 'min';
                            } else {
                                formattedTime = ' ' + hours + 'h ' + minutes + 'min';
                            }
                            if (minutes == 0) {
                                formattedTime = ' < 1min';
                            }
                            jsonWorker['uptime'] = _('Offline for') + formattedTime;
                        } else {
                            jsonWorker['uptime'] = _('Offline for') + ' > 24h';
                        }
                    }
                }
            } else {
                if (typeof w['info'].last_seen != 'undefined') {
                    var lastSeen = w['info'].last_seen;
                    var timeNow = Math.round((new Date().getTime()) / 1000);
                    if (timeNow - 24 * 60 * 60 < lastSeen) {
                        var timeTotalSec = timeNow - lastSeen;
                        var minutes = 0;
                        var hours = 0;
                        var sec = 0;
                        minutes = timeTotalSec / 60;
                        if (minutes > 60) {
                            hours = Math.floor(minutes / 60);
                            minutes = Math.ceil(minutes - hours * 60);
                        } else {
                            minutes = Math.ceil(minutes);
                        }
                        var formattedTime = '';
                        if (hours == 0) {
                            formattedTime = ' ' + minutes + 'min';
                        } else {
                            formattedTime = ' ' + hours + 'h ' + minutes + 'min';
                        }
                        if (minutes == 0) {
                            formattedTime = ' < 1min';
                        }
                        jsonWorker['uptime'] = _('Offline for') + formattedTime;
                    } else {
                        jsonWorker['uptime'] = _('Offline for') + ' > 24h';
                    }
                }
            }
            jsonWorker['filterString'] = filters_string;
            if (typeof jsonWorker.remoteip == 'undefined') {
                jsonWorker.remoteip = '-';
            }
            if (typeof jsonWorker.localip == 'undefined') {
                jsonWorker.localip = '-';
            }
            if (typeof jsonWorker.mining_status == 'undefined') {
                jsonWorker.mining_status = '-';
            }
            if (typeof jsonWorker.temp == 'undefined') {
                jsonWorker.temp = '-';
            }
            if (typeof jsonWorker.fan == 'undefined') {
                jsonWorker.fan = '-';
            }
            if (typeof jsonWorker.watt == 'undefined') {
                jsonWorker.watt = '-';
            }
            if (typeof jsonWorker.uptime == 'undefined') {
                jsonWorker.uptime = '-';
            }
            if (typeof jsonWorker.revenue == 'undefined') {
                jsonWorker.revenue = '-';
            }
            if (typeof jsonWorker.revenue_value == 'undefined') {
                jsonWorker.revenue_value = '-';
            }
            jsonWorkers.push(jsonWorker);
        });
        $.each(asicArrayIP, function (ip, workersArray) {
            if (workersArray.length > 1) {
                count_duplicatedips++;
                $.each(workersArray, function (workerIndex, workerName) {
                    $.each(jsonWorkers, function (jsonWorkersIndex, jsonWorkersData) {
                        if (jsonWorkersData["name"] == workerName[0]) {
                            jsonWorkersData["filterString"] += 'duplicatedips,';
                        }
                    });
                });
            }
        });
        $('#count_online').html(count_online);
        if (count_online == 0) {
            $('#count_online').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_online').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_offline').html(count_offline);
        if (count_offline == 0) {
            $('#count_offline').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_offline').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_idle').html(count_idle);
        if (count_idle == 0) {
            $('#count_idle').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_idle').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_alerts_pause').html(count_alerts_pause);
        if (count_alerts_pause == 0) {
            $('#count_alerts_pause').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_alerts_pause').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_triggers_pause').html(count_triggers_pause);
        if (count_triggers_pause == 0) {
            $('#count_triggers_pause').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_triggers_pause').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_notes').html(count_notes);
        if (count_notes == 0) {
            $('#count_notes').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_notes').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_profitswitch').html(count_profitswitch);
        if (count_profitswitch == 0) {
            $('#count_profitswitch').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_profitswitch').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_duplicatedips').html(count_duplicatedips);
        if (count_duplicatedips == 0) {
            $('#count_duplicatedips').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_duplicatedips').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_nospace').html(count_nospace);
        if (count_nospace == 0) {
            $('#count_nospace').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_nospace').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_nospeed').html(count_nospeed);
        if (count_nospeed == 0) {
            $('#count_nospeed').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_nospeed').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_noefficiency').html(count_noefficiency);
        if (count_noefficiency == 0) {
            $('#count_noefficiency').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_noefficiency').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_notemperature').html(count_notemperature);
        if (count_notemperature == 0) {
            $('#count_notemperature').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_notemperature').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_nofans').html(count_nofans);
        if (count_nofans == 0) {
            $('#count_nofans').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_nofans').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_nopool').html(count_nopool);
        if (count_nopool == 0) {
            $('#count_nopool').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_nopool').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_nocoin').html(count_nocoin);
        if (count_nocoin == 0) {
            $('#count_nocoin').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_nocoin').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_missinggpus').html(count_missinggpus);
        if (count_missinggpus == 0) {
            $('#count_missinggpus').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_missinggpus').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_idlegpus').html(count_idlegpus);
        if (count_idlegpus == 0) {
            $('#count_idlegpus').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_idlegpus').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_hotlimit').html(count_hotlimit);
        if (count_hotlimit == 0) {
            $('#count_hotlimit').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_hotlimit').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_veryhotlimit').html(count_veryhotlimit);
        if (count_veryhotlimit == 0) {
            $('#count_veryhotlimit').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_veryhotlimit').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_stability').html(count_stability);
        if (count_stability == 0) {
            $('#count_stability').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_stability').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_reboots').html(count_reboots);
        if (count_reboots == 0) {
            $('#count_reboots').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_reboots').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        $('#count_console').html(count_console);
        if (count_console == 0) {
            $('#count_console').parent().addClass('noresults').parent().find('input').prop("disabled", true);
        } else {
            $('#count_console').parent().removeClass('noresults').parent().find('input').prop("disabled", false);
        }
        var groupsListStr = '';
        var groupsCount = 0;
        var filter_groups_ordered = [];
        $.each(filter_groups, function (groupName, groupCount) {
            filter_groups_ordered.push(groupName);
            groupsCount++;
        });
        filter_groups_ordered.sort();
        for (var i = 0; i < groupsCount; i++) {
            groupName = filter_groups_ordered[i];
            groupCount = filter_groups[groupName];
            if ($('.search_result').html().indexOf('<div class="result">' + groupName.toLowerCase() + ' <div class="icon close"></div></div>') != -1) {
                var checkedHtml = 'checked="checked"';
            } else {
                var checkedHtml = '';
            }
            groupsListStr += '<div class="checkbox_row"><input type="checkbox" id="filter_group_' + groupName.toLowerCase() + '" data-filter="' + groupName.toLowerCase() + '" name="filter_group_' + groupName + '" value="1" ' + checkedHtml + '><label for="filter_group_' + groupName.toLowerCase() + '">' + groupName + ' (' + groupCount + ')</label></div>';
        }
        ;$('#groupsFrame .checkbox_group').html(groupsListStr);
        if (groupsCount == 0) {
            $('#count_groups').parent().parent().hide();
        } else {
            $('#count_groups').html(groupsCount);
            $('#count_groups').parent().parent().show();
        }
        var coinsListStr = '';
        var coinsCount = 0;
        var filter_coins_ordered = [];
        $.each(filter_coins, function (coinName, coinCount) {
            filter_coins_ordered.push(coinName);
            coinsCount++;
        });
        filter_coins_ordered.sort();
        for (var i = 0; i < coinsCount; i++) {
            coinName = filter_coins_ordered[i];
            coinCount = filter_coins[coinName];
            if ($('.search_result').html().indexOf('<div class="result">' + coinName.toLowerCase() + ' <div class="icon close"></div></div>') != -1) {
                var checkedHtml = 'checked="checked"';
            } else {
                var checkedHtml = '';
            }
            coinsListStr += '<div class="checkbox_row"><input type="checkbox" id="filter_group_' + coinName.toLowerCase().replace('(', '').replace(')', '').replace(' ', '') + '" data-filter="' + coinName.toLowerCase() + '" name="filter_group_' + coinName.toLowerCase().replace('(', '').replace(')', '').replace(' ', '') + '" value="1" ' + checkedHtml + '><label for="filter_group_' + coinName.toLowerCase().replace('(', '').replace(')', '').replace(' ', '') + '">' + coinName + ' (' + coinCount + ')</label></div>';
        }
        ;$('#coinsFrame .checkbox_group').html(coinsListStr);
        if (coinsCount == 0) {
            $('#count_coins').parent().parent().hide();
        } else {
            $('#count_coins').html(coinsCount);
            $('#count_coins').parent().parent().show();
        }
        var clientsListStr = '';
        var clientsCount = 0;
        var filter_clients_ordered = [];
        $.each(filter_clients, function (clientName, clientCount) {
            filter_clients_ordered.push(clientName);
            clientsCount++;
        });
        filter_clients_ordered.sort();
        for (var i = 0; i < clientsCount; i++) {
            clientName = filter_clients_ordered[i];
            clientCount = filter_clients[clientName];
            if ($('.search_result').html().indexOf('<div class="result">' + clientName.toLowerCase() + ' <div class="icon close"></div></div>') != -1) {
                var checkedHtml = 'checked="checked"';
            } else {
                var checkedHtml = '';
            }
            clientsListStr += '<div class="checkbox_row"><input type="checkbox" id="filter_group_' + clientName.toLowerCase() + '" data-filter="' + clientName.toLowerCase() + '" name="filter_group_' + clientName + '" value="1" ' + checkedHtml + '><label for="filter_group_' + clientName.toLowerCase() + '">' + clientName + ' (' + clientCount + ')</label></div>';
        }
        $('#clientsFrame .checkbox_group').html(clientsListStr);
        if (clientsCount == 0) {
            $('#count_clients').parent().parent().hide();
        } else {
            $('#count_clients').html(clientsCount);
            $('#count_clients').parent().parent().show();
        }
        if (typeof groupsFrame != 'undefined' && groupsFrame != 'undefined') {
            groupsFrame.update();
        }
        if (typeof coinsFrame != 'undefined' && coinsFrame != 'undefined') {
            coinsFrame.update();
        }
        if (typeof clientsFrame != 'undefined' && clientsFrame != 'undefined') {
            clientsFrame.update();
        }
        var sortby = getUrlParameter('sortby');
        if (sortby == 'status') {
            sort = 'miningAsc';
        } else if (sortby == 'temperature') {
            sort = 'tempDesc';
        } else if (sortby == 'temperature-asc') {
            sort = 'tempAsc';
        } else {
            var v = document.cookie.match('(^|;) ?workersSort=([^;]*)(;|$)');
            sort = v ? v[2] : '';
        }
        if (sort != '') {
            workersSort(sort);
        } else {
            printWorkers();
        }
        if (userPermission == 'technical' || userPrimaryPermission == 'technical') {
            $('.flexRevenue').hide();
            $('.financialData').hide();
        }
        setTimeout(function () {
            workersRefresh(false);
        }, 20 * 1000);
        preloaderHide();
    }
}

var displayCounter;

function printWorkers() {
    var hiddenTab = '';
    if (selectedWorkers.length < 1) {
        $('#checked_rows').hide();
    } else {
        hiddenTab = 'hidden';
    }
    var workersArray = jsonWorkers;

    var counter = 0;
    displayCounter = 0;
    var arrayLength = workersArray.length;
    var workersHtml = '<tr>';
        workersHtml += '<th  class="flexWorker orderTh ' + hiddenTab + '">' + _mx('User') + '</th>';
        workersHtml += '<th  class="flexPower orderTh ' + hiddenTab + '">' + 'Key' + '</th>';
        workersHtml += '<th  class="flexPower  orderTh  ' + hiddenTab + '">' + _mx2('Relation Site') + '</th>';
        workersHtml += '<th  class="flexPower  orderTh  ' + hiddenTab + '">' + _mx2('Remarks') + '</th>';
        // workersHtml += '<th  class="flexPower  orderTh  ' + hiddenTab + '">' + _('Online') + '</th>';
        // workersHtml += '<th  class="flexPower  orderTh  ' + hiddenTab + '"></div>' + _('Offline') + '</th>';
        // workersHtml += '<th  class="flexPower  orderTh  ' + hiddenTab + '">' + _('Abnormal') + '</th>';
        // workersHtml += '<th  class="flexPower  orderTh  ' + hiddenTab + '">' + 'Highest<br>Tem.' + '</th>';
        // workersHtml += '<th  class="flexPower  orderTh  ' + hiddenTab + '">' +'Avg. <br>Power' + '</th>';
        // workersHtml += '<th  class="flexPower  orderTh  ' + hiddenTab + '">' + 'EST. Daily/<br>Monthly' + '</th>';
        // workersHtml += '<th  class="flexPower  orderTh  ' + hiddenTab + '">' + 'Remarks' + '</th>';
        // workersHtml += '<th  class="flexPower  orderTh  ' + hiddenTab + '">' + 'Site Key' + '</th>';
        // workersHtml += '<th  class="flexPower  orderTh  ' + hiddenTab + '">' + _('Address') + '</th>';
        workersHtml += '<th class="flexActions align_right actions_width">' + _mx('Actions') + '</th></tr>';
    $.each(workersArray, function (key, worker) {
        if (displayCounter < end && displayCounter >= start) {
            var canShow = true;
        } else {
            var canShow = false;
        }
        counter++;
        let siteP=''
        let siteStr=''
        if(worker.sites!=undefined){
            if(worker.sites.length>0){
                let mx=[]
                $.each(worker.sites,function (i,it) {
                    mx.push(it.name)
                })
                siteP='<div class="ttp">'+mx.join(',')+'<div class="tooltip"><div class="arrow"></div>' +mx.join(',')+'</div></div>'
                siteStr=mx.join(',')
            }
        }
        $tags = (','  + worker.name + ','+worker.key+','+worker.desc+','+siteStr+',').toLowerCase();
        var tagAll = tag.split(":");
        var tagsCount = tagAll.length;
        var tagsLoop = 0;
        var tagsFound = 0;

        $.each(tagAll, function (tKey, tVal) {
            if (tVal != '' && search != '') {
                if ($tags.indexOf(',' + tVal + ',') == -1 || $tags.indexOf(search) == -1) {
                    var display = 'display:none;';
                } else {
                    tagsFound++;
                }
            } else if (tVal != '') {
                if ($tags.indexOf(',' + tVal + ',') == -1) {
                    var display = 'display:none;';
                } else {
                    tagsFound++;
                }
            } else if (search != '') {
                if ($tags.indexOf(search) == -1) {
                    var display = 'display:none;';
                } else {
                    tagsFound++;
                }
            } else {
                tagsFound++;
            }
            tagsLoop++;
            tagsCount--;
            if (tagsCount == 0) {
                if (tagsFound == tagsLoop) {
                    displayCounter++;
                    if (canShow) {
                        var display = '';
                    } else {
                        var display = 'display:none;';
                    }
                    // var tags = '';
                    // var tagsArray = worker.groups.split(",");
                    // $.each(tagsArray, function (key, tag) {
                    //     var tag = tag.replace(';', '');
                    //     if (tag != '') {
                    //         tags += '<span class="tag">' + tag + '</span>';
                    //     }
                    // });
                    var borderAddOn = '';
                    if (viewMode == 1) {
                        borderAddOn = ' class="noborder"';
                    }
                    if (access == 'guest') {
                        if (worker.mining_status != '-') {
                            if (rigType == 'asic') {
                                actions = '<div class="icons_list hide">';
                                actions += '	<span data-tooltip="' + _('Statistics') + '" class="icon_box"><div class="icon stats"></div></span>';
                                actions += '	<span data-tooltip="' + _('Details') + '" class="icon_box"><div class="icon details"></div></span>';
                                actions += '</div>';
                                actions += '<div class="icons_list_hamburger"></div>';
                            } else {
                                actions = '<div class="icons_list hide">';
                                actions += '	<span data-tooltip="' + _('Statistics') + '" class="icon_box"><div class="icon stats"></div></span>';
                                actions += '	<span data-tooltip="' + _('Details') + '" class="icon_box"><div class="icon details"></div></span>';
                                actions += '</div>';
                                actions += '<div class="icons_list_hamburger"></div>';
                            }
                        } else {
                            actions = '<div class="icons_list hide">';
                            actions += '	<span data-tooltip="' + _('Statistics') + '"  class="icon_box"><div class="icon stats"></div></span>';
                            actions += '	<span data-tooltip="' + _('Details') + '"  class="icon_box"><div class="icon details"></div></span>';

                            actions += '</div>';
                            actions += '<div class="icons_list_hamburger"></div>';
                        }
                        var pauseTags = '';
                        if (worker['pause_alerts'] == 1) {
                            pauseTags += '<div data-tooltip="' + _('Alerts paused') + '" class="icon pause_alerts"></div>';
                        }
                        if (worker['pause_triggers'] == 1) {
                            pauseTags += '<div data-tooltip="' + _('Triggers paused') + '" class="icon pause_triggers"></div>';
                        }
                        if (pauseTags != '') {
                            pauseTags = '<div class="pause_icons">' + pauseTags + '</div>';
                        }
                        console.log('选项',actions)
                        workersHtml += '<tr data-worker="' + worker.name+ '" data-id="'+worker.id+'" data-name="' + worker.name + '" style="' + display + '"' + borderAddOn + '>';
                        // workersHtml += '	<td class="flexCheckbox check_width"><div class="checkbox"></div></td>';
                        workersHtml += '	<td class="flexStatus status_width"></td>';
                        workersHtml += '	<td class="flexWorker"><div class="worker_name_box"><span class="worker_name" '+ worker.name + '">' + worker.name + '</span></td>';
                        workersHtml += '	<td data-responsive="' + _("Key") + '" class="flexTemp filter_avgtemp">' + worker.key + '</td>';
                        workersHtml += '	<td data-responsive="' + _mx2("Relation Site") + '" class="flexTemp filter_avgtemp">' + siteP + '</td>';
                        workersHtml += '	<td data-responsive="' + _mx2("Remarks") + '" class="flexFans filter_avgfans">' + worker.desc + '</td>';

                        workersHtml += '	<td class="flexActions align_right actions_width">' + actions + '</td>';
                        workersHtml += '</tr>';
                    } else {
                        var cpuTooltip = _('CPU mining disabled');
                        var cpuToggle = '';
                        if (worker.client_cpu != '' && worker.client_cpu != 'disabled') {
                            cpuTooltip = _('CPU mining enabled');
                            cpuToggle = 'selected';
                        }
                        var switchTooltip = _('Profit switch disabled');
                        var switchToggle = '';
                        if (worker.profit_switch == '1') {
                            switchTooltip = _('Profit switch enabled');
                            switchToggle = 'selected';
                        }
                        var cpuHtml = '';
                        var rigType = worker.type;
                        var rigSystem = worker.system;
                        if (rigSystem == 'linux') {
                            rigSystem = 'msos';
                        }
                        if (rigSystem == 'win') {
                            rigSystem = 'windows';
                        }
                        var clientsList = '<b>' + _('Load from template') + '</b>';
                        var countTemplates = 0;
                        var configTemplatesArray = [];
                        var configTemplatesObj = {};
                        jQuery.each(clients, function (client, data) {
                            if ($.inArray(rigType, data['for']) !== -1 && $.inArray(rigSystem, data['for']) !== -1 && typeof data['templates'] != 'undefined') {
                                $.each(data['templates'], function (index, value) {
                                    configTemplatesArray.push(value.name.toLowerCase());
                                    configTemplatesObj[value.name.toLowerCase()] = {};
                                    configTemplatesObj[value.name.toLowerCase()]['id'] = value.id;
                                    configTemplatesObj[value.name.toLowerCase()]['name'] = value.name;
                                    configTemplatesObj[value.name.toLowerCase()]['client'] = client.toUpperCase();
                                    countTemplates++;
                                });
                            }
                            if (rigType != 'asic') {
                                if ($.inArray(rigSystem, data['for']) !== -1 && $.inArray('cpu', data['for']) !== -1) {
                                    cpuHtml = '<div class="divider"></div><div class="row"><label>' + _('CPU mining') + '</label><div data-tooltip="' + cpuTooltip + '" class="cpumining toggle" onclick="cpuMining(\'' + worker.name + '\');"><div class="bullet ' + cpuToggle + '"></div></div></div>';
                                }
                            }
                        });
                        configTemplatesArray.sort();
                        jQuery.each(configTemplatesArray, function (configTemplateIndex, configTemplateName) {
                            configTemplateData = configTemplatesObj[configTemplateName];
                            clientsList += '<div class="row" data-template="' + configTemplateData['id'] + '">' + configTemplateData['name'] + '<small>' + configTemplateData['client'] + '</small></div>';
                        });
                        if (countTemplates == 0) {
                            clientsList += '<div class="empty">' + _('No templates') + '</div><a class="button green" href="/config-templates/new" title="' + _('Create new template') + '">' + _('Create new template') + '</a>';
                        }
                        // var client = worker.client.toUpperCase();
                        // clientsList = clientsList.replace('class="row">' + client, 'class="row selected">' + client);
                        if (display == '') {
                            if (worker.mining_status != '-') {
                                if (rigType == 'asic') {
                                    actions = '<div class="icons_list hide">';
                                    actions += '	<div data-tooltip="' + _mx('Delete') + '" class="icon_box" onclick="delSite(\'' + worker.name + '\','+worker.id+');"><div class="icon bin"></div></div>';
                                    actions += '	<div data-tooltip="' + _mx('Edit') + '" class="icon_box" onclick="addKeyShow('+ worker.id +');"><div class="icon rename"></div></div>';
                                    actions += '	<div data-tooltip="' + _mx('Copy Key') + '" class="icon_box" onclick="copyKey(\''+worker.key+'\');"><div class="icon duplicate"></div></div>';
                                    // actions += '	<div data-tooltip="' + _('Reboot machine') + '" class="icon_box" onclick="rebootMachine(\'' + worker.name + '\');"><div class="icon reboot"></div></div>';
                                    // actions += '	<div class="icon_box disabled"><div class="icon restart disabled"></div></div>';
                                    // actions += '	<div data-tooltip="' + _mx('Update Key') + '" class="icon_box" onclick="onclick="showUpdateKey('+worker.id+',\''+worker.key+'\',\'' + worker.name + '\');"><div class="icon restart"></div></div>';
                                    // actions += '	<div class="switch_menu"><div class="frame">' + clientsList + '</div><div class="divider"></div><div class="row"><label>' + _('Profit switch') + '</label><div data-tooltip="' + switchTooltip + '" class="profitswitch toggle" onclick="profitSwitch(\'' + worker.name + '\');"><div class="bullet ' + switchToggle + '"></div></div></div></div>';
                                    // actions += '	<a data-tooltip="' + _('Profit switch') + '" href="/profit-switch/' + worker.name + '" class="financialData icon_box"><div class="icon profit_switch"></div></a>';
                                    // actions += '	<a data-tooltip="' + _('Config') + '" onclick="linkConfig('+worker.id+')" class="financialData icon_box"><div class="icon config"></div></a>';
                                    // actions += '	<a data-tooltip="' + _('Details') + '" onclick="linkWorkers(\''+worker.groupName+'\')" class="icon_box"><div class="icon details"></div></a>';
                                    actions += '</div>';
                                    actions += '<div class="icons_list_hamburger"></div>';
                                } else {
                                    actions = '<div class="icons_list hide">';
                                    actions += '	<div data-tooltip="' + _mx('Delete') + '" class="icon_box" onclick="delSite(\'' + worker.name + '\','+worker.id+');"><div class="icon bin"></div></div>';
                                    actions += '	<div data-tooltip="' + _mx('Edit') + '" class="icon_box" onclick="addKeyShow('+ worker.id +');"><div class="icon rename"></div></div>';
                                    actions += '	<div data-tooltip="' + _mx('Copy Key') + '" class="icon_box" onclick="copyKey(\''+worker.key+'\');"><div class="icon duplicate"></div></div>';
                                    // actions += '	<div data-tooltip="' + _('Reboot machine') + '" class="icon_box" onclick="rebootMachine(\'' + worker.name + '\');"><div class="icon reboot"></div></div>';
                                    // actions += '	<div data-tooltip="' + _('Restart software') + '" class="icon_box" onclick="restartSoftware(\'' + worker.name + '\');"><div class="icon restart"></div></div>';
                                    // actions += '	<div data-tooltip="' + _mx('Update Key') + '" class="icon_box" onclick="showUpdateKey('+worker.id+',\''+worker.key+'\',\'' + worker.name + '\');"><div class="icon restart"></div></div>';
                                    // actions += '	<div class="switch_menu"><div class="frame">' + clientsList + '</div>' + cpuHtml + '<div class="divider"></div><div class="row"><label>' + _('Profit switch') + '</label><div data-tooltip="' + switchTooltip + '" class="profitswitch toggle" onclick="profitSwitch(\'' + worker.name + '\');"><div class="bullet ' + switchToggle + '"></div></div></div></div>';
                                    // actions += '	<a data-tooltip="' + _('Profit switch') + '" href="/profit-switch/' + worker.name + '" class="financialData icon_box"><div class="icon profit_switch"></div></a>';
                                    // actions += '	<a data-tooltip="' + _('Config') + '" onclick="linkConfig('+worker.id+')" class="financialData icon_box"><div class="icon config"></div></a>';
                                    // actions += '	<a data-tooltip="' + _('Details') + '" onclick="linkWorkers(\''+worker.groupName+'\')" class="icon_box"><div class="icon details"></div></a>';
                                    actions += '</div>';
                                    actions += '<div class="icons_list_hamburger"></div>';
                                }
                            } else {
                                actions = '<div class="icons_list hide">';
                                actions += '	<div data-tooltip="' + _mx('Delete') + '" class="icon_box" onclick="delSite(\'' + worker.name + '\','+worker.id+');"><div class="icon bin"></div></div>';
                                actions += '	<div data-tooltip="' + _mx('Edit') + '" class="icon_box" onclick="addKeyShow('+ worker.id +');"><div class="icon rename"></div></div>';
                                actions += '	<div data-tooltip="' + _mx('Copy Key') + '" class="icon_box" onclick="copyKey(\''+worker.key+'\');"><div class="icon duplicate"></div></div>';
                                // actions += '	<div data-tooltip="' + _mx('Update Key') + '" class="icon_box" onclick="showUpdateKey('+worker.id+',\''+worker.key+'\',\'' + worker.name + '\');"><div class="icon restart"></div></div>';
                                // actions += '	<a data-tooltip="' + _('Profit switch') + '" href="/profit-switch/' + worker.name + '" class="financialData icon_box"><div class="icon profit_switch"></div></a>';
                                // actions += '	<a data-tooltip="' + _('Config') + '" onclick="linkConfig('+worker.id+')" class="financialData icon_box"><div class="icon config"></div></a>';
                                // actions += '	<a data-tooltip="' + _('Details') + '" onclick="linkWorkers(\''+worker.groupName+'\')" class="icon_box"><div class="icon details"></div></a>';
                                actions += '</div>';
                                actions += '<div class="icons_list_hamburger"></div>';
                            }
                            // if (selectedWorkers.indexOf(worker.name) > -1) {
                            //     var selected = 'selected';
                            // } else {
                            //     var selected = '';
                            // }
                            if (selectedWorkers.indexOf(worker.id) > -1) {
                                var selected = 'selected';
                            } else {
                                var selected = '';
                            }
                            var pauseTags = '';
                            if (worker['pause_alerts'] == 1) {
                                pauseTags += '<div data-tooltip="' + _('Alerts paused') + '" class="icon pause_alerts"></div>';
                            }
                            if (worker['pause_triggers'] == 1) {
                                pauseTags += '<div data-tooltip="' + _('Triggers paused') + '" class="icon pause_triggers"></div>';
                            }
                            if (pauseTags != '') {
                                pauseTags = '<div class="pause_icons">' + pauseTags + '</div>';
                            }
                            workersHtml += '<tr data-worker="' + worker.name + '" data-id="'+worker.id+'" data-name="' + worker.name + '" style="' + display + '"' + borderAddOn + '>';
                            // workersHtml += '	<td class="flexCheckbox check_width"><div class="checkbox ' + selected + '"></div></td>';
                            // workersHtml += '	<td class="flexStatus status_width"></td>';
                            workersHtml += '	<td class="flexWorker"><div class="worker_name_box"><span class="worker_name" '+ worker.name + '">' + worker.name + '</span></td>';
                            // workersHtml += '	<td data-responsive="' + _("ID") + '" class="flexPower mining_status"></div>' + totalH + '</td>';
                            workersHtml += '	<td data-responsive="' + _("Key") + '" class="flexPower filter_avgtemp">' + worker.key + '</td>';
                            workersHtml += '	<td data-responsive="' + _("Relation Site") + '" class="flexPower filter_avgtemp">' + siteP + '</td>';
                            workersHtml += '	<td data-responsive="' + _("Remarks") + '" class="flexPower filter_avgfans">' + worker.desc + '</td>';
                            // workersHtml += '	<td data-responsive="' + _("Offline") + '" class="flexPower filter_watt">' + worker.offline + '</td>';
                            // workersHtml += '	<td data-responsive="' + _("Abnormal") + '" class="flexPower filter_uptime">' + worker.abnormal + '</td>';
                            // workersHtml += '	<td data-responsive="' + _("Highest Tem.") + '" class="flexPower mining_revenue">' + worker.highestTem + '%</td>';
                            // workersHtml += '	<td data-responsive="' + _("Avg. Power") + '" class="flexPower mining_revenue">' + worker.avgPower + 'W</td>';
                            // workersHtml += '	<td data-responsive="' + _("EST. Daily/Monthly") + '" class="flexPower mining_revenue">' + worker.estDaily+'/'+worker.estMonthly+ '</td>';
                            // workersHtml += '	<td data-responsive="' + _("Address") + '" class="flexPower mining_revenue">' + wN + '</td>';
                            // workersHtml += '	<td data-responsive="' + _("Remarks") + '" class="flexPower mining_revenue">' + wN + '</td>';
                            // workersHtml += '	<td data-responsive="' + _("Site Key") + '" class="flexPower mining_revenue">' + wN + '</td>';
                            workersHtml += '	<td class="flexActions align_right actions_width">' + actions + '</td>';
                            workersHtml += '</tr>';
                        }
                    }
                    if (viewMode == 1) {
                        workersHtml += '<tr data-worker="' + worker.name.toLowerCase() + '" data-id="'+worker.id+'" data-name="' + worker.name + '" style="' + display + '" class="hardware_list">';
                        workersHtml += '	<td colspan="10">';
                        workersHtml += '		<div class="hardware_row">';
                        if (typeof worker.hardware_list != 'undefined' && worker.hardware_list.length != 0) {
                            var hardwareCount = 0;
                            var speedCount = 0;
                            jQuery.each(worker.hardware_list, function (hardwareIndex, hardwareData) {
                                if (typeof hardwareData.speed != 'undefined') {
                                    speedCount++;
                                }
                            });
                            jQuery.each(worker.hardware_list, function (hardwareIndex, hardwareData) {
                                var hardwareName = hardwareData.name;
                                if (typeof hardwareName != 'undefined' && hardwareName != '') {
                                    hardwareName = hardwareName.replace(/AMD|Nvidia|GeForce|MSI|Gigabyte|ASUS|ZOTAC|eVga|Sapphire|XFX|Radeon|Series|24GB|16GB|11GB|10GB|8GB|6GB|4GB|3GB|0GB/g, '');
                                    hardwareName = hardwareName.replace('VII', 'Radeon VII');
                                    if (hardwareName.indexOf('Ellesmere') != -1) {
                                        hardwareName = '';
                                    }
                                    hardwareName = '#' + hardwareCount + ' ' + hardwareName;
                                } else {
                                    hardwareName = '#' + hardwareCount;
                                }
                                var hardwareFan = '-';
                                if (typeof hardwareData.fan != 'undefined' && hardwareData.fan > 0) {
                                    if (hardwareData.fan > 105) {
                                        hardwareFan = hardwareData.fan + ' RPM';
                                    } else {
                                        if (hardwareData.fan > 105) {
                                            hardwareData.fan = 100;
                                        }
                                        hardwareFan = hardwareData.fan + '%';
                                    }
                                }
                                var elColor = 0;
                                var tempColor = 0;
                                var speedColor = 0;
                                var tempAddOn = '';
                                if (typeof worker.temp_hot != 'undefined' && worker.temp_hot != 'undefined' > 0 && hardwareData.temp >= worker.temp_hot) {
                                    tempAddOn = '<div class="icon warning"></div>';
                                    tempColor = 1;
                                    elColor = 1;
                                }
                                if (typeof worker.temp_veryhot != 'undefined' && worker.temp_veryhot != 'undefined' > 0 && hardwareData.temp >= worker.temp_veryhot) {
                                    tempAddOn = '<div class="icon hot"></div>';
                                    tempColor = 2;
                                    elColor = 2;
                                }
                                var hardwareTemp = '-';
                                if (typeof hardwareData.temp != 'undefined') {
                                    hardwareTemp = convertTemperature(hardwareData.temp) + temperature;
                                }
                                if (typeof hardwareData.temp2 != 'undefined') {
                                    hardwareTemp += ' &middot; ' + convertTemperature(hardwareData.temp2) + temperature;
                                }
                                if (typeof hardwareData.memTemp != 'undefined') {
                                    hardwareTemp += ' &middot; ' + convertTemperature(hardwareData.memTemp) + temperature;
                                }
                                var hardwarePower = '-';
                                if (typeof hardwareData.power != 'undefined') {
                                    hardwarePower = hardwareData.power + ' W';
                                }
                                var hardwareSpeed = '-';
                                if (typeof hardwareData.speed != 'undefined') {
                                    var convertedHashrate = convertHashrate(speedToHash(hardwareData.speed, worker.mining_unit), 'H/s');
                                    hardwareSpeed = convertedHashrate.split(' ')[0] + '<span class="sub">' + convertedHashrate.split(' ')[1] + '</span>';
                                } else {
                                    if (speedCount > 0 && worker.type != 'asic') {
                                        elColor = 2;
                                        speedColor = 2;
                                    }
                                }
                                workersHtml += '		<div class="hardware_el color' + elColor + '">';
                                workersHtml += '			<div class="hardware_header">' + hardwareName + '</div>';
                                if (speedCount > 0) {
                                    workersHtml += '			<div class="el_row el_hashrate color' + speedColor + '"><b>' + hardwareSpeed + '</b></div>';
                                    workersHtml += '			<div class="divider"></div>';
                                }
                                workersHtml += '			<div class="el_row el_data color' + tempColor + '">' + hardwareTemp + '</div>';
                                workersHtml += '			<div class="el_row el_data">' + hardwareFan + '</div>';
                                workersHtml += '			<div class="el_row el_data">' + hardwarePower + '</div>';
                                if (typeof hardwareData.core != 'undefined' || typeof hardwareData.vddc != 'undefined' || typeof hardwareData.memory != 'undefined' || typeof hardwareData.mvdd != 'undefined') {
                                    workersHtml += '			<div class="hardware_tooltip">';
                                    workersHtml += '				<div class="el_row">';
                                    if (typeof hardwareData.core != 'undefined' && hardwareData.core != '') {
                                        workersHtml += '<label>CORE</label>' + '<b>' + hardwareData.core + ' MHz</b>';
                                    }
                                    if (typeof hardwareData.vddc != 'undefined' && hardwareData.vddc != '') {
                                        workersHtml += '<label>VDDC</label>' + '<b>' + hardwareData.vddc + ' mV</b>';
                                    }
                                    if (typeof hardwareData.memory != 'undefined' && hardwareData.memory != '') {
                                        workersHtml += '<label>MEM</label>' + '<b>' + hardwareData.memory + ' MHz</b>';
                                    }
                                    if (typeof hardwareData.mvdd != 'undefined' && hardwareData.mvdd != '') {
                                        workersHtml += '<label>MVDD</label>' + '<b>' + hardwareData.mvdd + ' mV</b>';
                                    }
                                    workersHtml += '				</div>';
                                    workersHtml += '			</div>';
                                }
                                workersHtml += '		</div>';
                                hardwareCount++;
                            });
                        }
                        workersHtml += '		</div>';
                        workersHtml += '	</td>';
                        workersHtml += '</tr>';
                    }
                }
            }
        });
        if (counter == arrayLength) {
            $('table').html(workersHtml);
            $('.loader_frame').removeClass('display');
            var pagesHtml = '';
            pages = Math.ceil(displayCounter / 25);
            if (pages > 0) {
                for (p = 1; p <= pages; p++) {
                    if (p == page) {
                        pagesHtml += '<div class="page selected" onclick="workersPage(' + p + ');">' + p + '</div>';
                    } else {
                        pagesHtml += '<div class="page" onclick="workersPage(' + p + ');">' + p + '</div>';
                    }
                }
                $('.pages').html(pagesHtml);
            }
        }
    });
    if (userPermission == 'technical' || userPrimaryPermission == 'technical') {
        $('.flexRevenue').hide();
        $('.financialData').hide();
    }
}

$('table').on('click', '.switch_menu > .frame > .row', function () {
    if ($(this).hasClass('selected')) {
        $('.switch_menu').fadeOut('fast');
        return false;
    }
    var workerName = $(this).closest('tr').attr('data-worker');
    var template = $(this).attr('data-template');
    var nonce = $('#nonce').val();
    if (workerName == '' || template == '' || nonce == '') {
        return false;
    }
    $.post(window.location.href, {worker: workerName, template: template, nonce: nonce}, function (response) {
        $('.switch_menu').fadeOut('fast');
    });
});
$('#rename_worker .green').on('click', function () {
    if ($(this).attr('data-wn') == '' || $(this).hasClass('disabled')) {
        return false;
    }
    var groupUnfinished = $('#popup_tag').val();
    if (groupUnfinished != '') {
        $('#popup_tag').before('<div class="tag" data-value="' + groupUnfinished + '">' + groupUnfinished + ' <div class="icon close"></div></div>');
        $('#popup_tag').val('');
    }
    $('#rename_worker .outlined_button, #rename_worker .green').addClass('disabled');
    $('.checkmark').hide();
    $('.circle-loader').removeClass('load-complete');
    $('.circle-loader, .message_err, .message_suc').hide();
    $('.circle-loader').show();
    var workerName = $(this).attr('data-wn');
    var nonce = $('#nonce').val();
    var newName = $('#rename_worker input').val();
    if (newName == '') {
        return false;
    }
    var ip = $('#rename_worker .asicip').val();
    var username = $('#rename_worker .asicuser').val();
    var password = $('#rename_worker .asicpassword').val();
    var type = $('#rename_worker #popup_type').val();
    var systemAsic = $('#rename_worker #popup_system_asic').val();
    var systemGpu = $('#rename_worker #popup_system_gpu').val();
    var groups = '';
    $('#rename_worker #groups').find('.tag').each(function () {
        groups += ';' + $(this).attr('data-value') + ';';
    });
    $.post(window.location.href, {
        worker: workerName,
        groups: groups,
        type: type,
        systemAsic: systemAsic,
        systemGpu: systemGpu,
        name: newName,
        ip: ip,
        username: username,
        password: password,
        nonce: nonce
    }, function (response) {
        if (response == '1') {
            workersRefresh(false);
            $('.circle-loader').addClass('load-complete');
            $('.notification_row').addClass('finished');
            $('.checkmark').show();
            $('.message_suc').show();
            setTimeout(function () {
                $('#rename_worker').fadeOut('fast');
                $('.popupbackground').fadeOut('fast');
                setTimeout(function () {
                    $('#rename_worker .outlined_button, #rename_worker .green').removeClass('disabled');
                    $('.checkmark').hide();
                    $('.circle-loader').removeClass('load-complete');
                    $('.circle-loader, .message_err, .message_suc').hide();
                }, 100);
            }, 1200);
            location.reload();
        } else {
            $('.circle-loader').hide();
            $('.notification_row').addClass('finished');
            $('#rename_worker .outlined_button, #rename_worker .green').removeClass('disabled');
            $('.message_err').show();
        }
        setTimeout(function () {
            $('#rename_worker .outlined_button, #rename_worker .green').removeClass('disabled');
        }, 2010);
    });
});

function editNote(wn) {
    var nonce = $('#nonce').val();
    $.post(window.location.href, {workerNote: wn, nonce: nonce}, function (response) {
        $('#edit_note textarea').val(response);
    });
    var scrollTop = $(window).scrollTop() + 20;
    $('#edit_note').css('top', scrollTop + 'px');
    $('#edit_note .title').html(wn + '\'s notes');
    $('.popupbackground').fadeToggle();
    $('#edit_note').fadeToggle('fast');
    $('#edit_note .green').attr('data-wn', wn);
}

$('.reset_button').click(function () {
    $('#edit_note textarea').val('');
});
$('#edit_note .green').on('click', function () {
    if ($(this).attr('data-wn') == '' || $(this).hasClass('disabled')) {
        return false;
    }
    $('#edit_note .outlined_button, #edit_note .green').addClass('disabled');
    $('.checkmark').hide();
    $('.circle-loader').removeClass('load-complete');
    $('.circle-loader, .message_err, .message_suc').hide();
    $('.circle-loader').show();
    var workerName = $(this).attr('data-wn');
    var nonce = $('#nonce').val();
    var note = $('#edit_note textarea').val();
    $.post(window.location.href, {worker: workerName, note: note, nonce: nonce}, function (response) {
        if (response == '1') {
            workersRefresh(false);
            $('.circle-loader').addClass('load-complete');
            $('.notification_row').addClass('finished');
            $('.checkmark').show();
            $('.message_suc').show();
            setTimeout(function () {
                $('#edit_note').fadeOut('fast');
                $('.popupbackground').fadeOut('fast');
                setTimeout(function () {
                    $('#edit_note .outlined_button, #edit_note .green').removeClass('disabled');
                    $('.checkmark').hide();
                    $('.circle-loader').removeClass('load-complete');
                    $('.circle-loader, .message_err, .message_suc').hide();
                }, 100);
            }, 1200);
        } else {
            $('.circle-loader').hide();
            $('.notification_row').addClass('finished');
            $('#edit_note .outlined_button, #edit_note .green').removeClass('disabled');
            $('.message_err').show();
        }
        setTimeout(function () {
            $('#edit_note .outlined_button, #edit_note .green').removeClass('disabled');
        }, 4500);
    });
});

function renameWorker(wn) {
    $('#rename_worker .asic > input').val('');
    $('#rename_worker .asic').hide();
    $('#rename_worker .asicpassword').val('admin');
    $('#rename_worker .asicuser').val('root');
    $('#rename_worker #popup_system_asic').hide();
    $('#rename_worker #popup_system_gpu').hide();
    $('#rename_worker #popup_type option').prop('selected', false);
    $('#rename_worker #popup_type option').removeAttr('selected');
    $('#rename_worker #popup_system_asic option').prop('selected', false);
    $('#rename_worker #popup_system_asic option').removeAttr('selected');
    $('#rename_worker #popup_system_gpu option').prop('selected', false);
    $('#rename_worker #popup_system_gpu option').removeAttr('selected');
    $('#rename_worker #groups .tag').remove();
    var workersArray = $.parseJSON(workers);
    var counterOfWorkers = 0;
    $.each(workersArray, function (key, worker) {
        counterOfWorkers++;
        if (worker.workersName == wn) {
            var groupsList = (worker.workersGroups).split(';');
            $.each(groupsList, function (gi, gn) {
                if (gn != '') {
                    $('#popup_tag').before('<div class="tag" data-value="' + gn + '">' + gn + ' <div class="icon close"></div></div>');
                }
            });
            if (worker.workersType == 'asic') {
                $('#rename_worker .asic').show();
                $('#rename_worker #popup_system_asic').show();
                $('#popup_type option[value="asic"]').prop('selected', true);
                $('#popup_type option[value="asic"]').attr("selected", "selected");
                $('#popup_system_asic option[value="' + worker.workersSystem + '"]').prop('selected', true);
                $('#popup_system_asic option[value="' + worker.workersSystem + '"]').attr("selected", "selected");
                var wlist = sessionStorage.getItem(workerToken.toLowerCase() + ".workersList");
                var wtemp = $.parseJSON(wlist);
                $.each(wtemp, function (w, d) {
                    if (w == wn) {
                        $('#rename_worker .asic .asicip').val(d.info.os.localip);
                        $('#rename_worker .asic .asicuser').val(d.info.auth.user);
                        $('#rename_worker .asic .asicpassword').val(d.info.auth.pass);
                        return;
                    }
                });
            } else {
                if (worker.workersType == 'amd') {
                    $('#popup_type option[value="amd"]').prop('selected', true);
                    $('#popup_type option[value="amd"]').attr("selected", "selected");
                }
                if (worker.workersType == 'nvidia') {
                    $('#popup_type option[value="nvidia"]').prop('selected', true);
                    $('#popup_type option[value="nvidia"]').attr("selected", "selected");
                }
                if (worker.workersSystem == 'msos' || worker.workersSystem == 'linux') {
                    $('#popup_system_gpu option[value="msos"]').prop('selected', true);
                    $('#popup_system_gpu option[value="msos"]').attr("selected", "selected");
                }
                if (worker.workersSystem == 'windows') {
                    $('#popup_system_gpu option[value="windows"]').prop('selected', true);
                    $('#popup_system_gpu option[value="windows"]').attr("selected", "selected");
                }
                $('#rename_worker #popup_system_gpu').show();
            }
            return;
        }
    });
    var nonce = $('#nonce').val();
    var scrollTop = $(window).scrollTop() + 20;
    $('#rename_worker').css('top', scrollTop + 'px');
    $('.popupbackground').fadeToggle();
    $('#rename_worker').fadeToggle('fast');
    $('#rename_worker > .text > .row > .chars_left').html((15 - wn.length) + ' ' + _('chars left'));
    $('#rename_worker > .text > .row > .wn').val(wn);
    $('#rename_worker .green').attr('data-wn', wn);
}

function deleteWorker(wn,id) {
    $('#worker_delete .title').html(_('Delete') + ' ' + wn + '?');
    $('#worker_delete .gray').text(_('No, keep it'));
    $('#worker_delete .red').text(_('Yes, delete it'));
    $('.popupbackground').fadeToggle();
    $('#worker_delete').fadeToggle('fast');
    $('#worker_delete .red').attr('data-wn', id);
}

$('#worker_delete .red').on('click', function () {
    if ($(this).attr('data-wn') == '' || $(this).hasClass('disabled')) {
        return false;
    }
    $('#worker_delete .outlined_button, #worker_delete .red').addClass('disabled');
    $('.checkmark').hide();
    $('.circle-loader').removeClass('load-complete');
    $('.circle-loader, .message_err, .message_suc').hide();
    $('.circle-loader').show();
    var id = $(this).attr('data-wn');
    var nonce = $('#nonce').val();
    delSiteSub(id)

});

function restartSoftware(wn) {
    $('#software_restart .title').html(_('Restart') + ' ' + wn + '?');
    $('#software_restart .gray').text(_('No, keep it'));
    $('#software_restart .blue').text(_('Yes, restart it'));
    $('.popupbackground').fadeToggle();
    $('#software_restart').fadeToggle('fast');
    $('#software_restart .blue').attr('data-wn', wn);
}

$('#software_restart .blue').on('click', function () {
    if ($(this).attr('data-wn') == '' || $(this).hasClass('disabled')) {
        return false;
    }
    $('#software_restart .outlined_button, #software_restart .blue').addClass('disabled');
    $('.checkmark').hide();
    $('.circle-loader').removeClass('load-complete');
    $('.circle-loader, .message_err, .message_suc').hide();
    $('.circle-loader').show();
    var workerName = $(this).attr('data-wn');
    var nonce = $('#nonce').val();
    $.post(window.location.href, {restartSoftware: workerName, nonce: nonce}, function (response) {
        if (response == '1') {
            $('.circle-loader').addClass('load-complete');
            $('.notification_row').addClass('finished');
            $('.checkmark').show();
            $('.message_suc').show();
            setTimeout(function () {
                $('#software_restart').fadeOut('fast');
                $('.popupbackground').fadeOut('fast');
                setTimeout(function () {
                    $('#software_restart .outlined_button, #software_restart .blue').removeClass('disabled');
                    $('.checkmark').hide();
                    $('.circle-loader').removeClass('load-complete');
                    $('.circle-loader, .message_err, .message_suc').hide();
                }, 100);
            }, 1200);
            deselectAll();
        } else {
            $('.circle-loader').hide();
            $('.notification_row').addClass('finished');
            $('#software_restart .outlined_button, #software_restart .blue').removeClass('disabled');
            $('.message_err').show();
        }
        setTimeout(function () {
            $('#software_restart .outlined_button, #software_restart .blue').removeClass('disabled');
        }, 4500);
    });
});

function openSwitch(thisEl) {
    if ($(thisEl).hasClass('disabled') == false) {
        if ($(thisEl).parent().children('.switch_menu').is(':visible')) {
            $('.switch_menu').hide();
            $(thisEl).parent().children('.switch_menu').fadeOut('fast');
            refreshStop = 0;
        } else {
            $('.switch_menu').hide();
            $(thisEl).parent().children('.switch_menu').fadeIn('fast');
            refreshStop = 1;
        }
    }
}

function rebootMachine(wn) {
    $('#hardware_reboot .title').html(_('Reboot') + ' ' + wn + '?');
    $('#hardware_reboot .gray').text(_('No, keep it'));
    $('#hardware_reboot .blue').text(_('Yes, reboot it'));
    $('.popupbackground').fadeToggle();
    $('#hardware_reboot').fadeToggle('fast');
    $('#hardware_reboot .blue').attr('data-wn', wn);
}

$('#hardware_reboot .blue').on('click', function () {
    if ($(this).attr('data-wn') == '' || $(this).hasClass('disabled')) {
        return false;
    }
    $('#hardware_reboot .outlined_button, #hardware_reboot .blue').addClass('disabled');
    $('.checkmark').hide();
    $('.circle-loader').removeClass('load-complete');
    $('.circle-loader, .message_err, .message_suc').hide();
    $('.circle-loader').show();
    var workerName = $(this).attr('data-wn');
    var nonce = $('#nonce').val();
    $.post(window.location.href, {rebootMachine: workerName, nonce: nonce}, function (response) {
        if (response == '1') {
            $('.circle-loader').addClass('load-complete');
            $('.notification_row').addClass('finished');
            $('.checkmark').show();
            $('.message_suc').show();
            setTimeout(function () {
                $('#hardware_reboot').fadeOut('fast');
                $('.popupbackground').fadeOut('fast');
                setTimeout(function () {
                    $('#hardware_reboot .outlined_button, #hardware_reboot .blue').removeClass('disabled');
                    $('.checkmark').hide();
                    $('.circle-loader').removeClass('load-complete');
                    $('.circle-loader, .message_err, .message_suc').hide();
                }, 100);
            }, 1200);
            deselectAll();
        } else {
            $('.circle-loader').hide();
            $('.notification_row').addClass('finished');
            $('#hardware_reboot .outlined_button, #hardware_reboot .blue').removeClass('disabled');
            $('.message_err').show();
        }
        setTimeout(function () {
            $('#hardware_reboot .outlined_button, #hardware_reboot .blue').removeClass('disabled');
        }, 4500);
    });
});
$('#workerName').on('keyup', function (event) {
    var str = $(this).val();
    str = str.replace(/[^A-Za-z-0-9_-]/g, "").substring(0, 15);
    if ($(this).val() != str) {
        $(this).val(str);
    }
    var chars = (15 - $(this).val().length) + ' ' + _('chars left');
    $('.chars_left').html(chars);
});
$('#rename_worker .wn').on('keyup', function (event) {
    var str = $(this).val();
    str = str.replace(/[^A-Za-z-0-9_-]/g, "").substring(0, 15);
    if ($(this).val() != str) {
        $(this).val(str);
    }
    var chars = (15 - $(this).val().length) + ' ' + _('chars left');
    $('#rename_worker .chars_left').html(chars);
});

function cpuMining(workerName) {
    var nonce = $('#nonce').val();
    var $worker = $('tr[data-worker="' + workerName.toLowerCase() + '"]');
    if ($worker.find('.cpumining .bullet').hasClass('selected')) {
        var statusCPU = 0;
    } else {
        var statusCPU = 1;
    }
    $.post('/workers', {'cpuMining': workerName, 'status': statusCPU, 'nonce': nonce}, function (response) {
        if (response == '1') {
            if (statusCPU == 0) {
                $worker.find('.cpumining .bullet').removeClass('selected');
                $worker.find('.cpumining .toggle').attr('data-tooltip', _('CPU mining disabled'));
            } else {
                $worker.find('.cpumining .bullet').addClass('selected');
                $worker.find('.cpumining .toggle').attr('data-tooltip', _('CPU mining enabled'));
            }
        }
    });
}

function profitSwitch(workerName) {
    var nonce = $('#nonce').val();
    var $worker = $('tr[data-worker="' + workerName.toLowerCase() + '"]');
    if ($worker.find('.profitswitch .bullet').hasClass('selected')) {
        var statusProfitSwitch = 0;
    } else {
        var statusProfitSwitch = 1;
    }
    $.post('/workers', {'profitSwitch': workerName, 'status': statusProfitSwitch, 'nonce': nonce}, function (response) {
        if (statusProfitSwitch == '0') {
            $worker.find('.profitswitch .bullet').removeClass('selected');
            $worker.find('.profitswitch').attr('data-tooltip', _('Profit switch disabled'));
        } else {
            $worker.find('.profitswitch .bullet').addClass('selected');
            $worker.find('.profitswitch').attr('data-tooltip', _('Profit switch enabled'));
        }
    });
}

$('#worker_shutdown .red').on('click', function () {
    if ($(this).attr('data-wn') == '' || $(this).hasClass('disabled')) {
        return false;
    }
    $('#worker_shutdown .outlined_button, #worker_shutdown .red').addClass('disabled');
    $('.checkmark').hide();
    $('.circle-loader').removeClass('load-complete');
    $('.circle-loader, .message_err, .message_suc').hide();
    $('.circle-loader').show();
    var workerName = $(this).attr('data-wn');
    var nonce = $('#nonce').val();
    $.post(window.location.href, {workerShutdownSafe: workerName, nonce: nonce}, function (response) {
        if (response == '1') {
            $('.circle-loader').addClass('load-complete');
            $('.notification_row').addClass('finished');
            $('.checkmark').show();
            $('.message_suc').show();
            setTimeout(function () {
                $('#worker_shutdown').fadeOut('fast');
                $('.popupbackground').fadeOut('fast');
                setTimeout(function () {
                    $('#worker_shutdown .outlined_button, #worker_shutdown .red').removeClass('disabled');
                    $('.checkmark').hide();
                    $('.circle-loader').removeClass('load-complete');
                    $('.circle-loader, .message_err, .message_suc').hide();
                }, 100);
            }, 1200);
            deselectAll();
        } else {
            $('.circle-loader').hide();
            $('.notification_row').addClass('finished');
            $('#worker_shutdown .outlined_button, #worker_shutdown .red').removeClass('disabled');
            $('.message_err').show();
        }
        setTimeout(function () {
            $('#worker_shutdown .outlined_button, #worker_shutdown .red').removeClass('disabled');
        }, 4500);
    });
});
$('#worker_power_cycle .red').on('click', function () {
    if ($(this).attr('data-wn') == '' || $(this).hasClass('disabled')) {
        return false;
    }
    $('#worker_power_cycle .outlined_button, #worker_power_cycle .red').addClass('disabled');
    $('.checkmark').hide();
    $('.circle-loader').removeClass('load-complete');
    $('.circle-loader, .message_err, .message_suc').hide();
    $('.circle-loader').show();
    var workerName = $(this).attr('data-wn');
    var nonce = $('#nonce').val();
    $.post(window.location.href, {workerPowerCycle: workerName, nonce: nonce}, function (response) {
        if (response == '1') {
            $('.circle-loader').addClass('load-complete');
            $('.notification_row').addClass('finished');
            $('.checkmark').show();
            $('.message_suc').show();
            setTimeout(function () {
                $('#worker_power_cycle').fadeOut('fast');
                $('.popupbackground').fadeOut('fast');
                setTimeout(function () {
                    $('#worker_power_cycle .outlined_button, #worker_power_cycle .red').removeClass('disabled');
                    $('.checkmark').hide();
                    $('.circle-loader').removeClass('load-complete');
                    $('.circle-loader, .message_err, .message_suc').hide();
                }, 100);
            }, 1200);
            deselectAll();
        } else {
            $('.circle-loader').hide();
            $('.notification_row').addClass('finished');
            $('#worker_power_cycle .outlined_button, #worker_power_cycle .red').removeClass('disabled');
            $('.message_err').show();
        }
        setTimeout(function () {
            $('#worker_power_cycle .outlined_button, #worker_power_cycle .red').removeClass('disabled');
        }, 4500);
    });
});
$('#software_update .blue').on('click', function () {
    if ($(this).attr('data-wn') == '' || $(this).hasClass('disabled')) {
        return false;
    }
    $('#software_update .outlined_button, #software_update .blue').addClass('disabled');
    $('.checkmark').hide();
    $('.circle-loader').removeClass('load-complete');
    $('.circle-loader, .message_err, .message_suc').hide();
    $('.circle-loader').show();
    var workerName = $(this).attr('data-wn');
    var nonce = $('#nonce').val();
    $.post(window.location.href, {update: workerName, nonce: nonce}, function (response) {
        if (response == '1') {
            $('.circle-loader').addClass('load-complete');
            $('.notification_row').addClass('finished');
            $('.checkmark').show();
            $('.message_suc').show();
            setTimeout(function () {
                $('#software_update').fadeOut('fast');
                $('.popupbackground').fadeOut('fast');
                setTimeout(function () {
                    $('#software_update .outlined_button, #software_update .blue').removeClass('disabled');
                    $('.checkmark').hide();
                    $('.circle-loader').removeClass('load-complete');
                    $('.circle-loader, .message_err, .message_suc').hide();
                }, 100);
            }, 1200);
            deselectAll();
        } else {
            $('.circle-loader').hide();
            $('.notification_row').addClass('finished');
            $('#software_update .outlined_button, #software_update .blue').removeClass('disabled');
            $('.message_err').show();
        }
        setTimeout(function () {
            $('#software_update .outlined_button, #software_update .blue').removeClass('disabled');
        }, 4500);
    });
});
$('#software_start .blue').on('click', function () {
    if ($(this).attr('data-wn') == '' || $(this).hasClass('disabled')) {
        return false;
    }
    $('#software_start .outlined_button, #software_start .blue').addClass('disabled');
    $('.checkmark').hide();
    $('.circle-loader').removeClass('load-complete');
    $('.circle-loader, .message_err, .message_suc').hide();
    $('.circle-loader').show();
    var workerName = $(this).attr('data-wn');
    var nonce = $('#nonce').val();
    $.post(window.location.href, {startMining: workerName, nonce: nonce}, function (response) {
        if (response == '1') {
            $('.circle-loader').addClass('load-complete');
            $('.notification_row').addClass('finished');
            $('.checkmark').show();
            $('.message_suc').show();
            setTimeout(function () {
                $('#software_start').fadeOut('fast');
                $('.popupbackground').fadeOut('fast');
                setTimeout(function () {
                    $('#software_start .outlined_button, #software_start .blue').removeClass('disabled');
                    $('.checkmark').hide();
                    $('.circle-loader').removeClass('load-complete');
                    $('.circle-loader, .message_err, .message_suc').hide();
                }, 100);
            }, 1200);
            deselectAll();
        } else {
            $('.circle-loader').hide();
            $('.notification_row').addClass('finished');
            $('#software_start .outlined_button, #software_start .blue').removeClass('disabled');
            $('.message_err').show();
        }
        setTimeout(function () {
            $('#software_start .outlined_button, #software_start .blue').removeClass('disabled');
        }, 4500);
    });
});
$('#software_stop .blue').on('click', function () {
    if ($(this).attr('data-wn') == '' || $(this).hasClass('disabled')) {
        return false;
    }
    $('#software_stop .outlined_button, #software_stop .blue').addClass('disabled');
    $('.checkmark').hide();
    $('.circle-loader').removeClass('load-complete');
    $('.circle-loader, .message_err, .message_suc').hide();
    $('.circle-loader').show();
    var workerName = $(this).attr('data-wn');
    var nonce = $('#nonce').val();
    $.post(window.location.href, {stopMining: workerName, nonce: nonce}, function (response) {
        if (response == '1') {
            $('.circle-loader').addClass('load-complete');
            $('.notification_row').addClass('finished');
            $('.checkmark').show();
            $('.message_suc').show();
            setTimeout(function () {
                $('#software_stop').fadeOut('fast');
                $('.popupbackground').fadeOut('fast');
                setTimeout(function () {
                    $('#software_stop .outlined_button, #software_stop .blue').removeClass('disabled');
                    $('.checkmark').hide();
                    $('.circle-loader').removeClass('load-complete');
                    $('.circle-loader, .message_err, .message_suc').hide();
                }, 100);
            }, 1200);
            deselectAll();
        } else {
            $('.circle-loader').hide();
            $('.notification_row').addClass('finished');
            $('#software_stop .outlined_button, #software_stop .blue').removeClass('disabled');
            $('.message_err').show();
        }
        setTimeout(function () {
            $('#software_stop .outlined_button, #software_stop .blue').removeClass('disabled');
        }, 4500);
    });
});
$('#search_templates').keyup(function () {
    var searchQuery = $(this).val();
    var countResults = 0;
    $('#actions_submenu_switch .frame .empty').remove();
    if (searchQuery == '') {
        $('#actions_submenu_switch .frame .row').show();
        if (ps_bulk_switch != null) {
            ps_bulk_switch.update();
        }
    } else {
        searchQuery = searchQuery.toLowerCase();
        $('#actions_submenu_switch .frame .row').each(function () {
            var profileStr = $(this).text();
            if (profileStr != '') {
                profileStr = profileStr.toLowerCase();
                profileStr = profileStr.replace('<small>', '----');
                profileStr = profileStr.replace('</small>', '');
                if (profileStr.indexOf(searchQuery) != -1) {
                    $(this).show();
                    countResults++;
                } else {
                    $(this).hide();
                }
            }
        });
        if (countResults == 0) {
            $('#actions_submenu_switch .frame').append('<div class="empty">' + _('No results') + '</div>');
        }
        if (ps_bulk_switch != null) {
            ps_bulk_switch.update();
        }
    }
});

function openSubmenu(type) {
    if (type == 'switch') {
        $('#actions_submenu_command').hide();
        $('#actions_submenu_relocate').hide();
        $('#actions_submenu_switch').toggle();
        ps_bulk_switch.update();
        $('#search_templates').focus();
    }
    if (type == 'command') {
        $('#actions_submenu_switch').hide();
        $('#actions_submenu_relocate').hide();
        $('#actions_submenu_command').toggle();
    }
    if (type == 'relocate') {
        $('#actions_submenu_switch').hide();
        $('#actions_submenu_command').hide();
        $('#actions_submenu_relocate').toggle();
    }
}

$(document).mousedown(function (e) {
    if (!$("#actions_submenu_switch").is(e.target) && $("#actions_submenu_switch").has(e.target).length === 0 && !$(".submenu_row").is(e.target)) {
        $("#actions_submenu_switch").hide();
    }
});
$(document).mousedown(function (e) {
    if (!$("#actions_submenu_command").is(e.target) && $("#actions_submenu_command").has(e.target).length === 0 && !$(".submenu_row").is(e.target)) {
        $("#actions_submenu_command").hide();
    }
});
$(document).mousedown(function (e) {
    if (!$("#actions_submenu_relocate").is(e.target) && $("#actions_submenu_relocate").has(e.target).length === 0 && !$(".submenu_row").is(e.target)) {
        $("#actions_submenu_relocate").hide();
    }
});

function massAction(type) {
    if (checkedNum > 0) {
        $('#actions_menu').hide();
        var workersInAction = '';
        let myWorkersInfo=''
        console.log('selectedWorkers',selectedWorkers)
        $.each(selectedWorkers, function (wName, value) {
            workersInAction = workersInAction + ',' + value;
        });
        workersInAction = workersInAction.substr(1);
        if (type == 'delete') {
            $('#worker_delete .title').html(_('Delete') + ' ' + checkedNum + ' ' + _('workers') + '?');
            if (checkedNum > 1) {
                $('#worker_delete .gray').text(_('No, keep them'));
                $('#worker_delete .red').text(_('Yes, delete them'));
            }
            $('.popupbackground').fadeToggle();
            $('#worker_delete').fadeToggle('fast');
            $('#worker_delete .red').attr('data-wn', workersInAction);
        }
        if (type == 'shutdown') {
            $('#worker_shutdown .title').html(_('Shut down') + ' ' + checkedNum + ' ' + _('workers') + '?');
            if (checkedNum > 1) {
                $('#worker_shutdown .gray').text(_('No, keep them'));
                $('#worker_shutdown .red').text(_('Yes, shut them down'));
            }
            $('.popupbackground').fadeToggle();
            $('#worker_shutdown').fadeToggle('fast');
            $('#worker_shutdown .red').attr('data-wn', workersInAction);
        }
        if (type == 'powercycle') {
            $('#worker_power_cycle .title').html(_('Power cycle') + ' ' + checkedNum + ' ' + _('workers') + '?');
            if (checkedNum > 1) {
                $('#worker_power_cycle .gray').text(_('No, keep them'));
                $('#worker_power_cycle .red').text(_('Yes, power cycle'));
            }
            $('.popupbackground').fadeToggle();
            $('#worker_power_cycle').fadeToggle('fast');
            $('#worker_power_cycle .red').attr('data-wn', workersInAction);
        }
        if (type == 'reboot') {
            $('#hardware_reboot .title').html(_('Reboot') + ' ' + checkedNum + ' ' + _('workers') + '?');
            if (checkedNum > 1) {
                $('#hardware_reboot .gray').text(_('No, keep them'));
                $('#hardware_reboot .blue').text(_('Yes, reboot them'));
            }
            $('.popupbackground').fadeToggle();
            $('#hardware_reboot').fadeToggle('fast');
            $('#hardware_reboot .blue').attr('data-wn', workersInAction);
        }
        if (type == 'restart') {
            $('#software_restart .title').html(_('Restart') + ' ' + checkedNum + ' ' + _('workers') + '?');
            if (checkedNum > 1) {
                $('#software_restart .gray').text(_('No, keep them'));
                $('#software_restart .blue').text(_('Yes, restart them'));
            }
            $('.popupbackground').fadeToggle();
            $('#software_restart').fadeToggle('fast');
            $('#software_restart .blue').attr('data-wn', workersInAction);
        }
        if (type == 'stop') {
            $('#software_stop .title').html(_('Stop') + ' ' + checkedNum + ' ' + _('workers') + '?');
            if (checkedNum > 1) {
                $('#software_stop .gray').text(_('No, keep them'));
                $('#software_stop .blue').text(_('Yes, stop them'));
            }
            $('.popupbackground').fadeToggle();
            $('#software_stop').fadeToggle('fast');
            $('#software_stop .blue').attr('data-wn', workersInAction);
        }
        if (type == 'start') {
            $('#software_start .title').html(_('Start') + ' ' + checkedNum + ' ' + _('workers') + '?');
            if (checkedNum > 1) {
                $('#software_start .gray').text(_('No, keep them'));
                $('#software_start .blue').text(_('Yes, start them'));
            }
            $('.popupbackground').fadeToggle();
            $('#software_start').fadeToggle('fast');
            $('#software_start .blue').attr('data-wn', workersInAction);
        }
        if (type == 'update') {
            $('#software_update .title').html(_('Update') + ' ' + checkedNum + ' ' + _('workers') + '?');
            if (checkedNum > 1) {
                $('#software_update .gray').text(_('No, keep them'));
                $('#software_update .blue').text(_('Yes, update them'));
            }
            $('.popupbackground').fadeToggle();
            $('#software_update').fadeToggle('fast');
            $('#software_update .blue').attr('data-wn', workersInAction);
        }
        if (type == 'command') {
            if (workersInAction != '') {
                var workerName = workersInAction;
                var nonce = $('#nonce').val();
                var selectedCommand = $('#command').val();
                $.post(window.location.href, {
                    commandTo: workerName,
                    'command': selectedCommand,
                    nonce: nonce
                }, function (response) {
                    if (response == '1') {
                        $('.circle-loader').addClass('load-complete');
                        $('.notification_row').addClass('finished');
                        $('.checkmark').show();
                        $('.message_suc').show();
                        deselectAll();
                    } else {
                        $('.circle-loader').hide();
                        $('.notification_row').addClass('finished');
                        $('#software_restart .outlined_button, #software_restart .blue').removeClass('disabled');
                        $('.message_err').show();
                    }
                });
            }
        }
        if (type == 'switch') {
            if (workersInAction != '') {
                var workerName = workersInAction;
                var nonce = $('#nonce').val();
                var selectedTemplate = '';
                if (typeof $('#actions_submenu_switch').find('.selected').data('template') != 'undefined') {
                    selectedTemplate = $('#actions_submenu_switch').find('.selected').data('template');
                }
                var subProfitSwitch = $('#actions_submenu_switch #submenu_profitswitch option:selected').val();
                var subCpu = $('#actions_submenu_switch #submenu_cpu option:selected').val();
                $.post(window.location.href, {
                    switchTo: workerName,
                    switchTemplate: selectedTemplate,
                    switchProfit: subProfitSwitch,
                    switchCpu: subCpu,
                    nonce: nonce
                }, function (response) {
                    if (response == '1') {
                        $('.circle-loader').addClass('load-complete');
                        $('.notification_row').addClass('finished');
                        $('.checkmark').show();
                        $('.message_suc').show();
                        deselectAll();
                    } else {
                        $('.circle-loader').hide();
                        $('.notification_row').addClass('finished');
                        $('#software_restart .outlined_button, #software_restart .blue').removeClass('disabled');
                        $('.message_err').show();
                    }
                });
            }
        }
        if (type == 'relocate') {
            if (workersInAction != '') {
                var workerName = workersInAction;
                var nonce = $('#nonce').val();
                var userRelocate = $('#submenu_relocate option:selected').val();
                $.post(window.location.href, {
                    workerRelocate: workerName,
                    userRelocate: userRelocate,
                    nonce: nonce
                }, function (response) {
                    if (response == '1') {
                        $.each(selectedWorkers, function (wName, value) {
                            $('#workersList > tr[data-name="' + value + '"]').remove();
                        });
                        $('.circle-loader').addClass('load-complete');
                        $('.notification_row').addClass('finished');
                        $('.checkmark').show();
                        $('.message_suc').show();
                        deselectAll();
                    } else {
                        $('.circle-loader').hide();
                        $('.notification_row').addClass('finished');
                        $('.message_err').show();
                    }
                });
            }
        }
        if (type == 'export') {
            if (workersInAction != '') {
                var workerName = workersInAction;
                var nonce = $('#nonce').val();
                $.post(window.location.href, {workerExport: workerName, nonce: nonce}, function (response) {
                    if (response != '0') {
                        var blob = new Blob([response], {type: 'application/octet-stream'});
                        var today = new Date();
                        var dd = String(today.getDate()).padStart(2, '0');
                        var mm = String(today.getMonth() + 1).padStart(2, '0');
                        var yyyy = today.getFullYear();
                        today = yyyy + '-' + mm + '-' + dd;
                        saveAs(blob, "workers-export-" + today + ".ms");
                    }
                });
            }
        }
        if (type == 'edit') {
            var nonce = $('#nonce').val();
            localStorage.setItem('myWorkes',workersInAction)
            localStorage.setItem('myType','site')
            window.location.replace("/config");
            // $.post('/config', {massEdit: workersInAction, nonce: nonce}, function (response) {
            //     if (response == '1') {
            //         preloaderShow();
            //         window.location.replace("/config");
            //         return false;
            //     }
            // });
        }
    }
}

$('#actions_submenu_switch .frame .row').click(function () {
    $('#actions_submenu_switch .frame .row').removeClass('selected');
    $(this).addClass('selected');
});
var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)), sURLVariables = sPageURL.split('&'),
        sParameterName, i;
    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
};
$('.filter_el').click(function () {
    $('.filter_popup').toggle();
    groupsFrame.update();
    coinsFrame.update();
    clientsFrame.update();
});
$('.filter_popup').on('change', 'input', function () {
    page = 1;
    window.location.hash = 1;
    tag = $(this).data('filter').toString().toLowerCase();
    var allTags = $('.search_result').html();
    if (this.checked == false) {
        allTags = allTags.replace('<div class="result">' + tag + ' <div class="icon close"></div></div>', '');
        tag = '';
    } else {
        if (allTags.indexOf('<div class="result">' + tag + ' <div class="icon close"></div></div>') == -1) {
            allTags = allTags + '<div class="result">' + tag + ' <div class="icon close"></div></div>';
        }
    }
    $('.search_result').html(allTags);
    $('.search_result > .result').each(function () {
        if (tag != '') {
            tag = tag + ':' + $(this).text().trim();
        } else {
            tag = $(this).text().trim();
        }
    });
    $('#checked_rows').hide();
    $('th').removeClass('hidden');
    $('#actions_menu').hide();
    $('table .checkbox').removeClass('selected');
    checkedNum = 0;
    selectedWorkers = [];
    var d = new Date;
    d.setTime(d.getTime() + 7 * 24 * 60 * 60 * 1000);
    document.cookie = "workersFilter=" + tag + ";path=/;expires=" + d.toGMTString();
    workersPage(page, search, tag, sort);
});
$(document).mousedown(function (e) {
    if (!$(".filter_popup").is(e.target) && $(".filter_popup").has(e.target).length === 0 && !$(".filter_el").is(e.target) && !$(".icon.filter").is(e.target)) {
        $(".filter_popup").hide();
    }
    if (!$(".icons_list_hamburger").is(e.target) && !$(".icon_box").is(e.target) && !$(".icon_box .icon").is(e.target) && !$(".switch_menu").find(e.target)) {
        $(".icons_list").addClass('hide');
        $(".switch_menu").hide();
        refreshStop = 0;
    }
});

function deselectAll() {
    $('#checked_rows').hide();
    $('th').removeClass('hidden');
    $('#actions_menu').hide();
    $('table .checkbox').removeClass('selected');
    checkedNum = 0;
    $('#count').html(0);
    selectedWorkers = [];
}

$('.view_el').on("click", function () {
    $('.loader_frame').addClass('display');
    if (viewMode == 0) {
        $('.view_el .icon').removeClass('view_compact');
        $('.view_el .icon').addClass('view_extended');
        $('.view_el').attr("data-tooltip", _('Change to compact view'));
        viewMode = 1;
    } else {
        $('.view_el .icon').removeClass('view_extended');
        $('.view_el .icon').addClass('view_compact');
        $('.view_el').attr("data-tooltip", _('Change to extended view'));
        viewMode = 0;
    }
    var d = new Date();
    d.setTime(d.getTime() + 3600 * 1000 * 24 * 7);
    var expires = "expires=" + d.toUTCString();
    document.cookie = "msWorkersView=" + viewMode + ";" + expires + ";path=/";
    setTimeout(function () {
        workersRefresh(true);
    }, 500);
});

function flarePing(url) {
    return new Promise(function (resolve, reject) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/" + url.replace(/\./g, '-') + ".lanflare.com:8008?discover=1");
        xhr.send()
        const timer = setTimeout(function () {
            done();
            xhr.abort();
        }, 1000);

        function done() {
            clearTimeout(timer);
            xhr.removeEventListener('error', error);
        }

        function error(e) {
            reject(e);
            done();
        }

        xhr.addEventListener('load', function () {
            resolve(xhr.response + '|' + url);
            done();
        });
        xhr.addEventListener('error', error);
    });
}

function flareUp(flare) {
    var nonce = $('#nonce').val();
    if (!$('.discover_workers_menu').find("[data-flare='" + flare + "']").find('.button').hasClass('finished')) {
        $('.discover_workers_menu').find("[data-flare='" + flare + "']").find('.button').addClass('waiting').html('<div class="bullet_1"></div><div class="bullet_2"></div><div class="bullet_3"></div>');
        $.post(window.location.href, {flareUp: flare, nonce: nonce}, function (response) {
            setTimeout(function () {
                if (response == '0') {
                    $('.discover_workers_menu').find("[data-flare='" + flare + "']").find('.button').removeClass('waiting').addClass('failed').html(_('Failed'));
                } else if (response == '1') {
                    $('.discover_workers_menu #start, .discover_workers_menu #error, .discover_workers_menu #finish').hide();
                    $('.discover_workers_menu #limit').show();
                } else {
                    var xhr2 = new XMLHttpRequest();
                    xhr2.open("GET", response);
                    xhr2.send();
                    $('.discover_workers_menu').find("[data-flare='" + flare + "']").find('.button').removeClass('waiting').addClass('finished').html(_('Added'));
                    workersRefresh(false);
                }
            }, 1000);
        });
    }
}

function flareScan() {
    var flareCount = 0;
    $('.discover_workers_menu #start, .discover_workers_menu #error, .discover_workers_menu #finish').hide();
    $('.discover_workers_menu .frame').html('');
    $('.discover_workers_menu #load').show();
    var nonce = $('#nonce').val();
    $.post(window.location.href, {flareCheck: '1', nonce: nonce}, function (response) {
        if (response == '0') {
            $('.discover_workers_menu #start, .discover_workers_menu #load, .discover_workers_menu #finish').hide();
            $('.discover_workers_menu #error').show();
        } else {
            flareNet = response.split(";");

            function flareLoop() {
                if ((flareCount + 1) % 5 === 0) {
                    timer = 1000;
                } else {
                    timer = 100;
                }
                setTimeout(function () {
                    flarePing(flareNet[flareCount]).then(function (reply) {
                        $('.discover_workers_menu #start, .discover_workers_menu #error, .discover_workers_menu #load').hide();
                        $('.discover_workers_menu #finish').show();
                        locdat = reply.split("|");
                        locdat[0] = reply.split("-")[0];
                        foundWorker = '<div class="row" data-flare="' + reply + '"><div class="element"><div class="tags"><div class="tag">' + locdat[0] + '</div><div class="tag tag_ip">' + locdat[1] + '</div></div></div><div class="element"><div class="button green" onclick="flareUp(\'' + reply + '\');">Add</div></div></div>';
                        $('.discover_workers_menu .frame').append(foundWorker);
                        ps_discovery.update();
                    });
                    flareCount++;
                    if (flareCount < flareNet.length) {
                        flareLoop();
                    } else {
                        setTimeout(function () {
                            if ($('.discover_workers_menu .frame').html() == '') {
                                $('.discover_workers_menu #load, .discover_workers_menu #error, .discover_workers_menu #finish').hide();
                                $('.discover_workers_menu #error').show();
                            }
                        }, 3000);
                    }
                }, timer);
            }

            flareLoop();
        }
    });
}

function getFilterTag() {
    var tagFromCookie = '';
    var tagCookie = (document.cookie).split(';');
    $.each(tagCookie, function (tci, tcv) {
        if (tcv.indexOf('workersFilter') != -1) {
            tagFromCookie = tcv.split('=')[1];
        }
    });
    if (tagFromCookie != '') {
        var tagFromCookieArray = tagFromCookie.split(':');
        var tagFromCookieStr = '';
        var tagFromCookieJson = {};
        $.each(tagFromCookieArray, function (tci, tcv) {
            if (typeof tagFromCookieJson[tcv] == 'undefined' || tagFromCookieJson[tcv] == null) {
                tagFromCookieJson[tcv] = 1;
                tagFromCookieStr += '<div class="result">' + tcv + ' <div class="icon close"></div></div>';
            }
        });
        $('.search_result').html(tagFromCookieStr);
    }
    return tagFromCookie;
}

var newWorkerType = '';
var newWorkerSystem = '';
var newWorkerASICIP = '';
var newWorkerASICUsername = '';
var newWorkerASICPassword = '';
var newWorkerName = '';

function newWorkerSelectType(workerType, thisEl) {
    $('.add_new_worker_step .message.red').hide();
    newWorkerType = workerType;
    $('.amd_element').removeClass('selected');
    $('.nvidia_element').removeClass('selected');
    $('.asic_element').removeClass('selected');
    $(thisEl).addClass('selected');
    $('#continueToSystem').removeClass('disabled');
}

function newWorkerSelectSystem(workerSystem, thisEl) {
    $('.add_new_worker_step .message.red').hide();
    newWorkerSystem = workerSystem;
    $('.msos_element').removeClass('selected');
    $('.windows_element').removeClass('selected');
    $(thisEl).addClass('selected');
    $('#continueToName').removeClass('disabled');
}

$('#new_worker_system_asic > .row > #ip').keyup(function () {
    $('#continueToName').removeClass('disabled');
});

function newWorkerContinue(step, thisEl) {
    $('.add_new_worker_step .message.red').hide();
    if (!$(thisEl).hasClass('disabled')) {
        $('.add_new_worker_step').hide();
        $('#new_worker_' + step).show();
        if (step == 'system') {
            $('.steps .step_2').addClass('selected');
            if (newWorkerType == 'asic') {
                $('#new_worker_system_gpu').hide();
                $('#new_worker_system_asic').show();
            } else {
                $('#new_worker_system_asic').hide();
                $('#new_worker_system_gpu').show();
            }
        }
        if (step == 'name') {
            if (newWorkerType == 'asic') {
                newWorkerSystem = $('#new_worker_system_asic > .row > #system_asic').val();
                newWorkerASICIP = $('#new_worker_system_asic > .row > #ip').val();
                newWorkerASICUsername = $('#new_worker_system_asic > .row > #sshuser').val();
                newWorkerASICPassword = $('#new_worker_system_asic > .row > #sshpass').val();
            }
            $('.steps .step_3').addClass('selected');
        }
    } else {
        $('.add_new_worker_step .message.red').show();
    }
}

function newWorkerBack(step, thisEl) {
    if ($(thisEl).hasClass('selected')) {
        $('.add_new_worker_step').hide();
        $('#new_worker_' + step).show();
        if (step == 'system') {
            $('.msos_element').removeClass('selected');
            $('.windows_element').removeClass('selected');
            $('.steps .step_3').removeClass('selected');
            $('#continueToName').addClass('disabled');
            newWorkerSystem = '';
            newWorkerName = '';
        }
        if (step == 'type') {
            $('.amd_element').removeClass('selected');
            $('.nvidia_element').removeClass('selected');
            $('.asic_element').removeClass('selected');
            $('.msos_element').removeClass('selected');
            $('.windows_element').removeClass('selected');
            $('.steps .step_3').removeClass('selected');
            $('.steps .step_2').removeClass('selected');
            $('#continueToSystem').addClass('disabled');
            $('#continueToName').addClass('disabled');
            newWorkerType = '';
            newWorkerSystem = '';
            newWorkerName = '';
        }
    }
}

$('#button_addfirstworker').on('click', function () {
    newWorkerName = $('#new_worker_name .row #workerName').val();
    var $this = $(this);
    if ($this.hasClass('disabled')) {
        return false;
    }
    $this.addClass('disabled');
    $('.checkmark').hide();
    $('.circle-loader').removeClass('load-complete');
    $('.circle-loader, .message_err, .message_suc').hide();
    $('.circle-loader').show();
    var workerName = newWorkerName;
    var type = newWorkerType;
    if (type == 'asic') {
        var system = newWorkerSystem;
        var asicIp = newWorkerASICIP;
        var asicSSHuser = newWorkerASICUsername;
        var asicSSHpass = newWorkerASICPassword;
    } else {
        var system = newWorkerSystem;
        var asicIp = '';
        var asicSSHuser = '';
        var asicSSHpass = '';
    }
    var tags = '';
    var nonce = $('#nonce').val();
    var data = '';
    console.log(workerName, asicSSHuser, asicSSHpass, asicIp, type, system, tags);
    $.post(window.location.href, {
        workerName: workerName,
        sshuser: asicSSHuser,
        sshpass: asicSSHpass,
        asicIp: asicIp,
        type: type,
        system: system,
        groups: tags,
        nonce: nonce
    }, function (response) {
        data = response;
        if (data == '1') {
            var d = new Date();
            d.setTime(d.getTime() + 24 * 60 * 60 * 1000 * 365);
            var expires = "expires=" + d.toLocaleTimeString();
            document.cookie = "cmode=automaticConfig;" + expires + ";path=/";
            window.location.replace("/worker/" + workerName);
        } else {
            $('.circle-loader').hide();
            $('.notification_row').addClass('finished');
            $this.removeClass('disabled');
            $('.message_err').html(data).show();
        }
    });
});

window.onload=function () {
    if(my_wy_key>=99){
        $('#isAdminShow').show()
        // getSiteList()
    }else {
        $('#isAdminShow').hide()
    }
    $('#mySiteKey').html(my_key_str);
	jQuery('#qrcode').qrcode({text: window.location.origin + "/token?"+my_key_str});
}

//显示新增Key窗口
function addKeyShow(id) {
    $('#keyAdd').show()
    $('.popupbackground').fadeToggle()
    if(id!=undefined){
        $('#keyAdd').attr('my-data-id',id)
        $('#keyAdd .title').html(_mx('Edit User Key'))
        $.each(jsonWorkers,function (i,it) {
            if(Number(id)===Number(it.id)){
                $('#keyName').val(it.name)
                $('#keyRemarks').val(it.desc)
                let m=[]
                if(it.sites!=undefined){
                    $.each(it.sites,function (k,j) {
                        m.push(j.id)
                    })
                }
                setSiteListDom(siteDataList,m)
            }
        })
    }else{
        $('#keyAdd .title').html(_mx('Add New User Key'))
    }
}

$('#tagsList').on('click',function () {
    let display =$('#my_select_target_menu').css('display');
    if (display=='none'){
        $('#my_select_target_menu').show()
    }else {
        $('#my_select_target_menu').hide()
    }
})



let siteDataList=[]
let selectSiteId=[]
// function getSiteList() {
//     $.post('/sitequery',function (res) {
//         siteDataList=res
//         setSiteListDom(siteDataList)
//     })
// }
//设置下拉dom
function setSiteListDom(data,ids,se) {
  if(ids==undefined){
      ids=[]
  }else {
      selectSiteId=ids
  }
  if(se==undefined){
      se=''
  }
  let str=''
  let _st=''
  $.each(data,function (i,it) {
     if(se.trim()==''||(it.name.indexOf(se.trim())!=-1)) {
      if(ids.indexOf(it.id)==-1){
          str+='<div class="row" id="chek'+it.id+'" data-id="'+it.id+'" data-name="'+it.name+'">' +
              '     <div class="checkbox"></div>' +
              '     <div class="mytext">'+it.name+'</div>' +
              '</div>'
      }else {
          str+='<div class="row" id="chek'+it.id+'" data-id="'+it.id+'" data-name="'+it.name+'">' +
              '     <div class="checkbox selected"></div>' +
              '     <div class="mytext">'+it.name+'</div>' +
              '</div>'
          _st+='<div onclick="clearTag(this,\'chek'+it.id+'\')" class="myTag" id="my'+it.id+'" data-id="'+it.id+'">'+it.name+'<small class="closx">x</small></div>'
      }
     }
  })
   $('#tagsList').html(_st)
   $('#target_site').html(str)
    $('#my_select_target_menu #target_site .row').on('click',function () {
        if(!$(this).find('.checkbox').hasClass('selected')){
            $(this).find('.checkbox').addClass('selected')
            $('#tagsList').append('<div onclick="clearTag(this,\''+$(this).attr('id')+'\')" class="myTag" id="my'+$(this).attr('data-id')+'" data-id="'+$(this).attr('data-id')+'">'+$(this).attr('data-name')+'<small class="closx">x</small></div>')

        }else {
            $(this).find('.checkbox').removeClass('selected')
            document.getElementById('my'+$(this).attr('data-id')).remove()
        }
    })

}
function clearTag(e,id){
    $('#my_select_target_menu').hide()
    $('#'+id).find('.checkbox').removeClass('selected')
    e.remove()
    e.stopPropagation();
}
$(document).click(function (e) {
    let mx=e.target
    if(!$(mx).is("#my_select_target_menu *")&&!$(mx).is('#my_select_target *')){
        $('#my_select_target_menu').hide()
    }
})

$('.popupbackground').on('click',function () {
    if(this.style.display!='none'){
        keyWinClose()

    }
    closeKeyPwdWin()
})
//关闭Key窗口
function  keyWinClose(){
    setSiteListDom(siteDataList)
    $('#tagsList').val('')
    $('.popupbackground').fadeToggle()
    $('#keyName').val('')
    $('#keyRemarks').val('')
    selectSiteId=[]

}

//新增key用户
function saveKey() {
   let listTag=document.getElementsByClassName('myTag')
    let name = $('#keyName').val()
    if(name.replace(/(^\s*)|(\s*$)/g, "").length===0){
        $('#myError').show()
    }else {
        $('#myError').hide()
    }
    let desc=$('#keyRemarks').val()
    let sites=[]
    $.each(listTag,function (i,it) {
        sites.push($(it).attr('data-id'))
    })
    $('.circle-loader').show()
   $.ajax({
       url:'/manager',
       type:'post',
       data:{
         name:name,
         desc:desc,
         sites:sites.length>0?sites.join(','):'',
         id:($('#keyAdd').attr('my-data-id')!=undefined&&$('#keyAdd').attr('my-data-id')!='')?$('#keyAdd').attr('my-data-id'):undefined
       },
       success:function (res) {
            if(res==1){
                $('.circle-loader').addClass('load-complete');
                $('.notification_row').addClass('finished');
                $('.checkmark').show();
                let x=setTimeout(function () {
                    $('.circle-loader').removeClass('load-complete');
                    $('.notification_row').removeClass('finished');
                    $('.checkmark').hide();
                    $('.circle-loader').hide()
                    $('#keyAdd').hide()
                    $('.popupbackground').fadeToggle();
                    $.getJSON('/managerquery', function (workersList) {
                        jsonWorkers=workersList
                        printWorkers()
                    });
                    clearTimeout(x)
                },2000)
            }else {
            $('.circle-loader').hide();
            $('.message_err').show();
}
       }
   })
}

function delSite(wn,id) {
    $('#worker_delete .title').html(_('Delete') + ' ' + wn + '?');
    $('#worker_delete .gray').text(_('No, keep it'));
    $('#worker_delete .red').text(_('Yes, delete it'));
    $('.popupbackground').fadeToggle();
    $('#worker_delete').fadeToggle('fast');
    $('#worker_delete .red').attr('data-wn', id);
}
//删除接口
function delSiteSub(id){
    $('.circle-loader').show()
    $.ajax({
        url:'/manager',
        type:'post',
        data:{
            delete:id
        },
        success:function (res) {
            if(res==1){
                $('.circle-loader').addClass('load-complete');
                $('.notification_row').addClass('finished');
                $('.checkmark').show();
                let x=setTimeout(function () {
                    $('.circle-loader').removeClass('load-complete');
                    $('.notification_row').removeClass('finished');
                    $('.checkmark').hide();
                    $('.circle-loader').hide()
                    $('#worker_delete').hide()
                    $('.popupbackground').fadeToggle();
                    $('#worker_delete .outlined_button, #worker_delete .red').removeClass('disabled');
                    $.getJSON('/managerquery', function (workersList) {
                        jsonWorkers=workersList
                        printWorkers()
                    });
                    clearTimeout(x)
                },2000)
            }else {
                $('#worker_delete .outlined_button, #worker_delete .red').removeClass('disabled');
                $('.circle-loader').hide();
                $('.message_err').show();
            }
        }
    })
}
//复制Key键
function copyKey(text) {
    const strDom=document.createElement('input')
    strDom.setAttribute('value',text)
    document.body.appendChild(strDom)
    $(strDom).select()
    document.execCommand('copy')
    document.body.removeChild(strDom)
    alert('复制成功')
}
//全选
function mySelectAll() {
    let m=[]
    $.each(siteDataList,function (i,it) {
        m.push(it.id)
    })
    setSiteListDom(siteDataList,m)
}

$('#tagListSearch').on('input',function () {
    setSiteListDom(siteDataList,selectSiteId,$(this).val())
})

//显示重置key值弹窗
function showUpdateKey(id,key,name) {
    $('#update_site').attr('data-id',id)
    // $('#update_text').html('name:'+name+'<br>key:'+key)
    $('#dUserName').val(name)
    $('#dUserKey').val(key)
    $('.popupbackground').fadeToggle();
    $('#update_site').show()
}
//关闭弹窗
function closeKeyPwdWin() {
    $('#keyEditPwd').hide()
    $('#pwd_one').val('')
    $('#pwd_tow').val('')
    $('#myError_pwd').hide()
}
//同步Key值
function updateKeySite() {
    $('.circle-loader').show()
    $.ajax({
        url:'/manager',
        type:'post',
        data:{
            update: $('#update_site').attr('data-id')
        },
        success:function (res) {
            if(res==1){
                $('.circle-loader').addClass('load-complete');
                $('.notification_row').addClass('finished');
                $('.checkmark').show();
                let x=setTimeout(function () {
                    $('.circle-loader').removeClass('load-complete');
                    $('.notification_row').removeClass('finished');
                    $('.checkmark').hide();
                    $('.circle-loader').hide()
                    $('#update_site').hide()
                    $('.popupbackground').fadeToggle();
                    $('#update_site .outlined_button, #update_site .red').removeClass('disabled');
                    $.getJSON('/managerquery', function (workersList) {
                        jsonWorkers=workersList
                        printWorkers()
                    });
                    clearTimeout(x)
                },2000)
            }else {
                $('#update_site .outlined_button, #update_site .red').removeClass('disabled');
                $('.circle-loader').hide();
                $('.message_err').show();
            }
        }
    })
}
//显示重置密码弹窗
function setPwdWin() {
    $('#keyEditPwd').show()
    $('.popupbackground').fadeToggle();
}

//显示重置自己key值弹窗
function showResetKey() {
    // $('.popupbackground').fadeToggle();
    if($('#pwd_one').val()!=$('#pwd_tow').val()){
        $('#pwd_msg').show()
    }else {
        $('#pwd_msg').hide()
        $('#reset_my_key').show()
    }
    // $('#reset_my_key').show()
}

//重置自己的Key
function resetMyKey() {
    $('.circle-loader').show()
    $.ajax({
        url:'/manager',
        type:'post',
        dataType:'text',
        data:{
            update: $('#myHeadId').attr('my-user-id'),
            pwd:$('#pwd_one').val(),
        },
        success:function (res) {
            // console.log(res)
            if(res==1){
                $('.circle-loader').addClass('load-complete');
                $('.notification_row').addClass('finished');
                $('.checkmark').show();
                let x=setTimeout(function () {
                    window.location.reload()
                    clearTimeout(x)
                },2000)
            }else if(res==0){
                $('#reset_my_key .outlined_button, #reset_my_key .red').removeClass('disabled');
                $('.circle-loader').hide();
                $('.message_err').show();
            }else {
                $('#reset_my_key .outlined_button, #reset_my_key .red').removeClass('disabled');
                $('.circle-loader').hide();
                $('.message_err').show();
                $('.message_err').html(res);
            }
        }
    })
}

//复制MyKey键
function copyMyKey() {
    const strDom=document.createElement('input')
    strDom.setAttribute('value',my_key_str)
    document.body.appendChild(strDom)
    $(strDom).select()
    document.execCommand('copy')
    document.body.removeChild(strDom)
    alert('复制成功')
}